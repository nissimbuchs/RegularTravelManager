#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Run linting via lint-staged (existing behavior)
echo "ğŸ“ Running lint-staged..."
npx lint-staged

# Run infrastructure validation for any API/Lambda changes
if git diff --cached --name-only | grep -E "(apps/api/|infrastructure/)" > /dev/null; then
    echo "ğŸ—ï¸  Detected infrastructure changes - validating..."
    npm run infrastructure:validate
    
    if [ $? -ne 0 ]; then
        echo ""
        echo "âŒ Infrastructure validation failed!"
        echo "ğŸ’¡ Please ensure all API endpoints and Lambda functions are properly configured in CDK."
        echo "   Run 'npm run story:complete' to validate your changes."
        exit 1
    fi
    
    echo "âœ… Infrastructure validation passed!"
else
    echo "â„¹ï¸  No infrastructure changes detected, skipping validation"
fi

echo "âœ… All pre-commit checks completed successfully!"