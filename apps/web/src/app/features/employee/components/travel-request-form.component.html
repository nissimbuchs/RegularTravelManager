<div class="travel-request-form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>{{ translationService.translateSync('employee.travel_request.title') }}</mat-card-title>
      <mat-card-subtitle>{{ translationService.translateSync('employee.travel_request.subtitle') }}</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="requestForm" (ngSubmit)="onSubmit()" class="form-content">
        <!-- Project Selection -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ translationService.translateSync('employee.travel_request.form.project.label') }}</mat-label>
          <mat-select formControlName="projectId" required>
            <mat-option value="">{{ translationService.translateSync('employee.travel_request.form.project.placeholder') }}</mat-option>
            <mat-option *ngFor="let project of projects" [value]="project.id">
              {{ project.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="requestForm.get('projectId')?.hasError('required')">
            {{ translationService.translateSync('employee.travel_request.form.project.error') }}
          </mat-error>
        </mat-form-field>

        <!-- Subproject Selection -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ translationService.translateSync('employee.travel_request.form.subproject.label') }}</mat-label>
          <mat-select formControlName="subProjectId" required [disabled]="!requestForm.get('projectId')?.value">
            <mat-option value="">{{ translationService.translateSync('employee.travel_request.form.subproject.placeholder') }}</mat-option>
            <mat-option *ngFor="let subproject of subprojects" [value]="subproject.id">
              {{ subproject.name }}
              <span *ngIf="subproject.city"> - {{ subproject.city }}</span>
            </mat-option>
          </mat-select>
          <mat-error *ngIf="requestForm.get('subProjectId')?.hasError('required')">
            {{ translationService.translateSync('employee.travel_request.form.subproject.error') }}
          </mat-error>
        </mat-form-field>

        <!-- Manager Selection -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ translationService.translateSync('employee.travel_request.form.manager.label') }}</mat-label>
          <mat-select formControlName="managerId" required>
            <mat-option value="">{{ translationService.translateSync('employee.travel_request.form.manager.placeholder') }}</mat-option>
            <mat-option *ngFor="let manager of managers" [value]="manager.id">
              {{ manager.name }} ({{ manager.employeeId }})
            </mat-option>
          </mat-select>
          <mat-hint>{{ translationService.translateSync('employee.travel_request.form.manager.hint') }}</mat-hint>
          <mat-error *ngIf="requestForm.get('managerId')?.hasError('required')">
            {{ translationService.translateSync('employee.travel_request.form.manager.error') }}
          </mat-error>
        </mat-form-field>

        <!-- Days Per Week -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ translationService.translateSync('employee.travel_request.form.days.label') }}</mat-label>
          <mat-select formControlName="daysPerWeek" required>
            <mat-option [value]="1">{{ translationService.translateSync('employee.travel_request.form.days.options.one') }}</mat-option>
            <mat-option [value]="2">{{ translationService.translateSync('employee.travel_request.form.days.options.two') }}</mat-option>
            <mat-option [value]="3">{{ translationService.translateSync('employee.travel_request.form.days.options.three') }}</mat-option>
            <mat-option [value]="4">{{ translationService.translateSync('employee.travel_request.form.days.options.four') }}</mat-option>
            <mat-option [value]="5">{{ translationService.translateSync('employee.travel_request.form.days.options.five') }}</mat-option>
            <mat-option [value]="6">{{ translationService.translateSync('employee.travel_request.form.days.options.six') }}</mat-option>
            <mat-option [value]="7">{{ translationService.translateSync('employee.travel_request.form.days.options.seven') }}</mat-option>
          </mat-select>
          <mat-error *ngIf="requestForm.get('daysPerWeek')?.hasError('required')">
            {{ translationService.translateSync('employee.travel_request.form.days.errors.required') }}
          </mat-error>
          <mat-error *ngIf="requestForm.get('daysPerWeek')?.hasError('min') || requestForm.get('daysPerWeek')?.hasError('max')">
            {{ translationService.translateSync('employee.travel_request.form.days.errors.range') }}
          </mat-error>
        </mat-form-field>

        <!-- Justification -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ translationService.translateSync('employee.travel_request.form.justification.label') }}</mat-label>
          <textarea 
            matInput 
            formControlName="justification" 
            rows="4"
            [placeholder]="translationService.translateSync('employee.travel_request.form.justification.placeholder')"
            required>
          </textarea>
          <mat-hint align="end">{{ translationService.translateSync('employee.travel_request.form.justification.hint', { current: justificationCharCount, max: 500 }) }}</mat-hint>
          <mat-error *ngIf="requestForm.get('justification')?.hasError('required')">
            {{ translationService.translateSync('employee.travel_request.form.justification.errors.required') }}
          </mat-error>
          <mat-error *ngIf="requestForm.get('justification')?.hasError('minlength')">
            {{ translationService.translateSync('employee.travel_request.form.justification.errors.minlength') }}
          </mat-error>
          <mat-error *ngIf="requestForm.get('justification')?.hasError('maxlength')">
            {{ translationService.translateSync('employee.travel_request.form.justification.errors.maxlength') }}
          </mat-error>
        </mat-form-field>

        <!-- Calculation Preview -->
        <div class="calculation-preview" *ngIf="calculationPreview || isCalculating">
          <mat-card class="preview-card">
            <mat-card-header>
              <mat-card-title class="preview-title">{{ translationService.translateSync('employee.travel_request.preview.title') }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="isCalculating" class="calculation-loading">
                <mat-spinner diameter="24"></mat-spinner>
                <span class="loading-text">{{ translationService.translateSync('employee.travel_request.preview.calculating') }}</span>
              </div>
              <div *ngIf="calculationPreview && !isCalculating" class="preview-details">
                <div class="preview-item">
                  <span class="label">{{ translationService.translateSync('employee.travel_request.preview.distance') }}:</span>
                  <span class="value">{{ calculationPreview.distance | number:'1.3-3' }} km</span>
                </div>
                <div class="preview-item">
                  <span class="label">{{ translationService.translateSync('employee.travel_request.preview.daily_allowance') }}:</span>
                  <span class="value">CHF {{ calculationPreview.dailyAllowance | number:'1.2-2' }}</span>
                </div>
                <div class="preview-item highlight">
                  <span class="label">{{ translationService.translateSync('employee.travel_request.preview.weekly_total') }}:</span>
                  <span class="value">CHF {{ calculationPreview.weeklyAllowance | number:'1.2-2' }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </form>
    </mat-card-content>

    <mat-card-actions class="form-actions">
      <button 
        mat-raised-button 
        color="primary" 
        type="submit"
        (click)="onSubmit()"
        [disabled]="!isFormValid || isSubmitting"
        class="submit-button">
        <mat-spinner *ngIf="isSubmitting" diameter="20" class="submit-spinner"></mat-spinner>
        {{ isSubmitting ? translationService.translateSync('employee.travel_request.actions.submitting') : translationService.translateSync('employee.travel_request.actions.submit') }}
      </button>
      <button mat-button type="button" class="cancel-button" (click)="onCancel()">
        {{ translationService.translateSync('employee.travel_request.actions.cancel') }}
      </button>
    </mat-card-actions>
  </mat-card>
</div>