
# Story 1.4: Authentication System with Cognito

## Status
Approved

## Story
**As a** developer,
**I want** AWS Cognito authentication integrated with role-based access control,
**so that** employees and managers can securely log in with appropriate permissions.

## Acceptance Criteria
1. Cognito User Pool configured with email-based authentication and password policies meeting business security requirements
2. User groups created for 'employees' and 'managers' with appropriate group membership management
3. JWT token validation implemented in Lambda authorizer function with proper error handling
4. Lambda authorizer returns user context including sub, email, and role information for downstream functions
5. API Gateway configured to use Lambda authorizer for all protected routes
6. Test users created in both employee and manager groups with verified email addresses
7. Authentication flow tested end-to-end from login through API access with proper authorization

## Tasks / Subtasks
- [ ] Configure Cognito User Pool (AC: 1)
  - [ ] Set up User Pool with email-based authentication
  - [ ] Configure password policies (minimum length, complexity requirements)
  - [ ] Set up email verification for new user registration
  - [ ] Configure user pool client settings for Angular frontend
  - [ ] Set up proper CORS settings for frontend integration

- [ ] Create user groups and roles (AC: 2)
  - [ ] Create 'employees' user group with appropriate permissions
  - [ ] Create 'managers' user group with elevated permissions  
  - [ ] Configure group membership management and assignment
  - [ ] Set up default groups for new user registration
  - [ ] Define group-based access control policies

- [ ] Implement JWT token validation (AC: 3)
  - [ ] Create Lambda authorizer function for JWT validation
  - [ ] Implement token signature verification using Cognito public keys
  - [ ] Add token expiration and claims validation
  - [ ] Implement proper error handling for invalid/expired tokens
  - [ ] Add comprehensive logging for authentication events

- [ ] Configure user context extraction (AC: 4)
  - [ ] Extract user ID (sub) from JWT token claims
  - [ ] Extract email address from token claims
  - [ ] Determine user role from Cognito group membership
  - [ ] Return structured user context for downstream Lambda functions
  - [ ] Handle edge cases for users without group assignments

- [ ] Integrate with API Gateway (AC: 5)
  - [ ] Configure API Gateway to use Lambda authorizer
  - [ ] Set up authorization on all protected API routes
  - [ ] Configure caching for authorization responses
  - [ ] Test authorization bypass for health check endpoints
  - [ ] Implement proper error responses for unauthorized access

- [ ] Create test users and data (AC: 6)
  - [ ] Create sample employee users with verified email addresses
  - [ ] Create sample manager users with verified email addresses
  - [ ] Assign users to appropriate groups (employees/managers)
  - [ ] Test user registration and email verification flow
  - [ ] Generate temporary passwords for testing purposes

- [ ] End-to-end authentication testing (AC: 7)
  - [ ] Test complete login flow from frontend to backend
  - [ ] Verify JWT token generation and validation
  - [ ] Test role-based access control for different user types
  - [ ] Test token refresh and expiration handling
  - [ ] Validate security headers and CORS configuration

## Dev Notes

### Architecture Context
From the architecture document (docs/architecture.md):
- **Authentication:** Amazon Cognito User Pools with JWT tokens
- **Authorization:** Role-based access control with employee/manager groups
- **Security:** JWT tokens with proper expiration and refresh (NFR7)
- **Integration:** Lambda authorizer with API Gateway for protected routes

### Security Requirements
From PRD requirements:
- **Role Distinction:** Authentication system distinguishes between employee and manager roles (FR14)
- **HTTPS/TLS:** All authentication must use encrypted transmission (NFR6)
- **JWT Security:** Tokens must expire and refresh according to security best practices (NFR7)
- **Access Control:** Appropriate permissions for different user roles

### Angular Frontend Integration
From the architecture document:
- **Angular Auth Service:** Service-based authentication with JWT token management
- **Auth Guards:** Route protection using Angular guards
- **HTTP Interceptors:** Automatic token inclusion and error handling
- **User Context:** Reactive user state management with role-based UI

### Lambda Authorizer Pattern
```typescript
// Expected authorizer response format
{
  principalId: payload.sub,
  policyDocument: {
    Version: '2012-10-17',
    Statement: [{
      Action: 'execute-api:Invoke',
      Effect: 'Allow',
      Resource: event.methodArn
    }]
  },
  context: {
    sub: payload.sub,
    email: payload.email,
    isManager: payload['cognito:groups']?.includes('managers') || false
  }
}
```

### Testing Requirements
- **Test Location:** apps/api/src/__tests__/auth/
- **Test Standards:** Unit tests for authorizer logic, integration tests for Cognito
- **Testing Frameworks:** Vitest with AWS SDK mocking
- **Specific Requirements:**
  - Test JWT token validation with valid/invalid/expired tokens
  - Test user group assignment and role determination  
  - Test API Gateway integration with authorization
  - Test CORS and security headers
  - Integration test with actual Cognito User Pool

### Testing
- **Test Location:** apps/api/src/__tests__/auth/ and apps/web/src/app/core/services/__tests__/
- **Test Standards:** Unit tests for auth services, integration tests for Cognito flow
- **Testing Frameworks:** 
  - Backend: Vitest with AWS SDK mocking
  - Frontend: Angular Testing Utilities with auth service testing
- **Specific Requirements:**
  - Test complete authentication flow from Angular to Lambda
  - Test role-based access control and route protection
  - Test JWT token handling and refresh logic
  - Test error scenarios (invalid credentials, network failures)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 1 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*