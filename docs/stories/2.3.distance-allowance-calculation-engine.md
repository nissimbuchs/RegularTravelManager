# Story 2.3: Distance and Allowance Calculation Engine

## Status
Approved

## Story
**As a** system,
**I want** to automatically calculate straight-line distances and daily allowances,
**so that** employees receive immediate, accurate cost estimates for their travel requests.

## Acceptance Criteria
1. PostGIS ST_Distance function calculates straight-line distance between employee home and subproject location in kilometers
2. Daily allowance calculation multiplies distance by subproject cost-per-kilometer rate with proper CHF decimal precision
3. Calculation engine handles edge cases including zero distance, missing coordinates, and invalid geographic data
4. Distance calculations cached for identical home-subproject combinations to improve performance
5. All calculations maintain 3 decimal places for distance and 2 decimal places for CHF amounts
6. Calculation audit trail stores original values for historical accuracy and compliance
7. Error handling provides meaningful messages when calculations cannot be performed

## Tasks / Subtasks
- [x] Implement PostGIS distance calculation (AC: 1)
  - [x] Create database function using ST_Distance for accurate calculations
  - [x] Handle geographic coordinate system conversion (WGS84)
  - [x] Implement kilometer conversion from meters
  - [x] Add geographic bounds validation for reasonable distances
  - [x] Test calculations with real Swiss coordinate data

- [x] Create allowance calculation service (AC: 2)
  - [x] Implement daily allowance calculation logic (distance × rate)
  - [x] Add proper CHF decimal precision handling (2 decimal places)
  - [x] Create weekly and monthly calculation aggregates
  - [x] Implement rate override logic for subproject-specific rates
  - [x] Add calculation result validation and bounds checking

- [x] Add comprehensive edge case handling (AC: 3)
  - [x] Handle zero distance scenarios gracefully
  - [x] Manage missing coordinate data with proper error responses
  - [x] Validate coordinate accuracy and reasonable bounds
  - [x] Handle invalid geographic projections and transformations
  - [x] Implement fallback calculations for geocoding failures

- [x] Implement calculation caching (AC: 4)
  - [x] Create cache key from employee home + subproject location hash
  - [x] Implement PostgreSQL-based calculation result caching
  - [x] Add cache invalidation when addresses change
  - [x] Set appropriate cache TTL for performance vs accuracy balance
  - [x] Monitor cache hit rates and performance improvements

- [x] Ensure calculation precision standards (AC: 5)
  - [x] Implement 3 decimal place precision for distance calculations
  - [x] Ensure 2 decimal place precision for CHF currency amounts
  - [x] Add rounding logic that follows Swiss financial standards
  - [x] Validate calculation precision in unit tests
  - [x] Create precision validation in calculation pipeline

- [x] Create calculation audit trail (AC: 6)
  - [x] Store original coordinates used for each calculation
  - [x] Record calculation timestamp and version information
  - [x] Save intermediate calculation steps for transparency
  - [x] Implement audit record creation for compliance
  - [x] Add calculation history retrieval for debugging

- [x] Implement robust error handling (AC: 7)
  - [x] Create specific error messages for different calculation failures
  - [x] Add user-friendly error translation for frontend display
  - [x] Implement calculation retry logic for temporary failures
  - [x] Log detailed error information for debugging
  - [x] Create error recovery workflows and fallback options

## Dev Notes

### Architecture Context
From the architecture document:
- **Database:** PostgreSQL with PostGIS extension for geographic calculations
- **Caching:** Amazon ElastiCache Redis for calculation performance
- **Geographic Functions:** PostGIS ST_Distance for accurate distance calculations
- **Precision:** Swiss financial standards for CHF calculations

### Calculation Requirements
From PRD requirements:
- **Distance Method:** Straight-line (PostGIS ST_Distance) calculations (FR2)
- **Currency:** Swiss Francs with proper decimal precision (FR15)
- **Precision:** 3 decimal places for distance, 2 for currency (NFR8)
- **Performance:** Support <500ms API response times (NFR1)

### Database Function Implementation
PostGIS calculation function from architecture:
```sql
-- Distance calculation function
CREATE OR REPLACE FUNCTION calculate_travel_distance(
    employee_location GEOMETRY,
    project_location GEOMETRY
) RETURNS DECIMAL(10,3) AS $$
BEGIN
    RETURN ST_Distance(
        employee_location::geography, 
        project_location::geography
    ) / 1000.0;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

### Calculation Logic
- **Daily Allowance** = Distance (km) × Cost per km rate (CHF)
- **Weekly Allowance** = Daily Allowance × Days per week
- **Geographic Precision** = WGS84 coordinate system (SRID 4326)

### Swiss Business Standards
- **Rounding:** Swiss financial rounding for CHF amounts
- **Distance Calculation:** Straight-line methodology for consistency
- **Cost Rates:** Project-specific rates with subproject overrides

### Testing
- **Test Location:** 
  - Backend: apps/api/src/__tests__/services/calculations/
  - Database: apps/api/src/__tests__/database/functions/
- **Test Standards:** 
  - Unit tests for calculation logic
  - Integration tests with PostGIS functions
- **Testing Frameworks:** 
  - Backend: Vitest with PostGIS test database
  - Calculation: Dedicated test suite with Swiss coordinate data
- **Specific Requirements:**
  - Test calculation accuracy with real Swiss locations
  - Test edge cases (zero distance, invalid coordinates)
  - Test calculation precision requirements
  - Test caching performance and invalidation
  - Test audit trail creation and retrieval

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 2 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Lambda build: Successfully bundled to 236.0kb with calculation engine
- PostGIS functions: Distance calculation, allowance calculation, and caching implemented
- Database cache: PostgreSQL-based caching with MD5 key generation and TTL expiration
- Precision handling: 3 decimal places for distance, 2 decimal places for CHF amounts
- Audit trail: Complete calculation history with coordinate and result storage

### Completion Notes List
- ✅ Implemented comprehensive PostGIS distance calculation engine with Swiss coordinate support
- ✅ Built high-performance calculation caching using PostgreSQL instead of Redis for simplicity
- ✅ Created complete allowance calculation service with CHF precision standards
- ✅ Added robust edge case handling for zero distance, missing coordinates, and invalid data
- ✅ Implemented calculation audit trail for compliance and historical tracking
- ✅ Built cache invalidation system for address and rate changes
- ✅ Created maintenance functions for expired cache cleanup
- ✅ Added comprehensive error handling and validation throughout calculation pipeline
- ✅ Enhanced infrastructure with calculation Lambda functions and monitoring alarms

### File List
- `apps/api/src/database/migrations/003_distance_calculation_functions.sql` - PostGIS calculation functions and caching tables
- `domains/calculation-engine/CalculationService.ts` - Calculation engine domain service interface
- `apps/api/src/handlers/calculations/engine.ts` - Calculation engine Lambda handlers
- `apps/api/src/__tests__/handlers/calculations/engine.test.ts` - Comprehensive calculation engine tests
- `apps/api/src/handlers/index.ts` - Updated handler exports with calculation functions
- `infrastructure/lib/lambda-stack.ts` - Enhanced Lambda infrastructure with calculation functions

## QA Results
*Results from QA Agent review will be populated here*