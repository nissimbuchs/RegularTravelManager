# Story 2.3: Distance and Allowance Calculation Engine

## Status
Approved

## Story
**As a** system,
**I want** to automatically calculate straight-line distances and daily allowances,
**so that** employees receive immediate, accurate cost estimates for their travel requests.

## Acceptance Criteria
1. PostGIS ST_Distance function calculates straight-line distance between employee home and subproject location in kilometers
2. Daily allowance calculation multiplies distance by subproject cost-per-kilometer rate with proper CHF decimal precision
3. Calculation engine handles edge cases including zero distance, missing coordinates, and invalid geographic data
4. Distance calculations cached for identical home-subproject combinations to improve performance
5. All calculations maintain 3 decimal places for distance and 2 decimal places for CHF amounts
6. Calculation audit trail stores original values for historical accuracy and compliance
7. Error handling provides meaningful messages when calculations cannot be performed

## Tasks / Subtasks
- [ ] Implement PostGIS distance calculation (AC: 1)
  - [ ] Create database function using ST_Distance for accurate calculations
  - [ ] Handle geographic coordinate system conversion (WGS84)
  - [ ] Implement kilometer conversion from meters
  - [ ] Add geographic bounds validation for reasonable distances
  - [ ] Test calculations with real Swiss coordinate data

- [ ] Create allowance calculation service (AC: 2)
  - [ ] Implement daily allowance calculation logic (distance × rate)
  - [ ] Add proper CHF decimal precision handling (2 decimal places)
  - [ ] Create weekly and monthly calculation aggregates
  - [ ] Implement rate override logic for subproject-specific rates
  - [ ] Add calculation result validation and bounds checking

- [ ] Add comprehensive edge case handling (AC: 3)
  - [ ] Handle zero distance scenarios gracefully
  - [ ] Manage missing coordinate data with proper error responses
  - [ ] Validate coordinate accuracy and reasonable bounds
  - [ ] Handle invalid geographic projections and transformations
  - [ ] Implement fallback calculations for geocoding failures

- [ ] Implement calculation caching (AC: 4)
  - [ ] Create cache key from employee home + subproject location hash
  - [ ] Implement Redis/ElastiCache for calculation result caching
  - [ ] Add cache invalidation when addresses change
  - [ ] Set appropriate cache TTL for performance vs accuracy balance
  - [ ] Monitor cache hit rates and performance improvements

- [ ] Ensure calculation precision standards (AC: 5)
  - [ ] Implement 3 decimal place precision for distance calculations
  - [ ] Ensure 2 decimal place precision for CHF currency amounts
  - [ ] Add rounding logic that follows Swiss financial standards
  - [ ] Validate calculation precision in unit tests
  - [ ] Create precision validation in calculation pipeline

- [ ] Create calculation audit trail (AC: 6)
  - [ ] Store original coordinates used for each calculation
  - [ ] Record calculation timestamp and version information
  - [ ] Save intermediate calculation steps for transparency
  - [ ] Implement audit record creation for compliance
  - [ ] Add calculation history retrieval for debugging

- [ ] Implement robust error handling (AC: 7)
  - [ ] Create specific error messages for different calculation failures
  - [ ] Add user-friendly error translation for frontend display
  - [ ] Implement calculation retry logic for temporary failures
  - [ ] Log detailed error information for debugging
  - [ ] Create error recovery workflows and fallback options

## Dev Notes

### Architecture Context
From the architecture document:
- **Database:** PostgreSQL with PostGIS extension for geographic calculations
- **Caching:** Amazon ElastiCache Redis for calculation performance
- **Geographic Functions:** PostGIS ST_Distance for accurate distance calculations
- **Precision:** Swiss financial standards for CHF calculations

### Calculation Requirements
From PRD requirements:
- **Distance Method:** Straight-line (PostGIS ST_Distance) calculations (FR2)
- **Currency:** Swiss Francs with proper decimal precision (FR15)
- **Precision:** 3 decimal places for distance, 2 for currency (NFR8)
- **Performance:** Support <500ms API response times (NFR1)

### Database Function Implementation
PostGIS calculation function from architecture:
```sql
-- Distance calculation function
CREATE OR REPLACE FUNCTION calculate_travel_distance(
    employee_location GEOMETRY,
    project_location GEOMETRY
) RETURNS DECIMAL(10,3) AS $$
BEGIN
    RETURN ST_Distance(
        employee_location::geography, 
        project_location::geography
    ) / 1000.0;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

### Calculation Logic
- **Daily Allowance** = Distance (km) × Cost per km rate (CHF)
- **Weekly Allowance** = Daily Allowance × Days per week
- **Geographic Precision** = WGS84 coordinate system (SRID 4326)

### Swiss Business Standards
- **Rounding:** Swiss financial rounding for CHF amounts
- **Distance Calculation:** Straight-line methodology for consistency
- **Cost Rates:** Project-specific rates with subproject overrides

### Testing
- **Test Location:** 
  - Backend: apps/api/src/__tests__/services/calculations/
  - Database: apps/api/src/__tests__/database/functions/
- **Test Standards:** 
  - Unit tests for calculation logic
  - Integration tests with PostGIS functions
- **Testing Frameworks:** 
  - Backend: Vitest with PostGIS test database
  - Calculation: Dedicated test suite with Swiss coordinate data
- **Specific Requirements:**
  - Test calculation accuracy with real Swiss locations
  - Test edge cases (zero distance, invalid coordinates)
  - Test calculation precision requirements
  - Test caching performance and invalidation
  - Test audit trail creation and retrieval

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 2 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*