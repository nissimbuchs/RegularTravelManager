# Story 2.2: Project and Subproject Data Management

## Status
Done

## Story
**As an** administrator,
**I want** to manage projects and subprojects with locations and cost rates,
**so that** employees can select valid projects and the system can calculate accurate allowances.

## Acceptance Criteria
1. Admin interface allows creation of projects with name, description, default cost per kilometer in CHF, and active status
2. Subproject management enables adding specific work locations with addresses, coordinates, and custom cost rates
3. Geocoding automatically converts subproject addresses to coordinates for distance calculations  
4. Cost per kilometer rates accept decimal values with CHF currency formatting and validation
5. Projects and subprojects can be marked active/inactive to control availability for new requests
6. Search and filtering capabilities allow efficient management of large project lists
7. Data validation ensures positive cost rates and prevents deletion of projects referenced by existing requests

## Tasks / Subtasks
- [x] Create project management Angular components (AC: 1)
  - [x] Design admin project list view with Angular Material table
  - [x] Create project creation form with name, description, cost rate, status fields
  - [x] Implement project editing capabilities with pre-populated forms
  - [x] Add project deletion with safety checks for referenced projects
  - [x] Create responsive admin interface for desktop and tablet use

- [x] Implement subproject management (AC: 2)
  - [x] Design subproject management interface linked to parent projects
  - [x] Create subproject form with location, address, and custom cost rate fields
  - [x] Implement subproject-to-project relationship management
  - [x] Add subproject location input with address autocomplete
  - [x] Create subproject list view with parent project context

- [x] Integrate geocoding for subprojects (AC: 3)
  - [x] Implement automatic geocoding when subproject address is entered
  - [x] Store subproject coordinates in PostGIS format
  - [x] Add geocoding validation and error handling
  - [x] Provide manual coordinate override for edge cases
  - [x] Display map preview for subproject locations

- [x] Implement CHF cost rate management (AC: 4)
  - [x] Create currency input components with CHF formatting
  - [x] Add decimal validation for cost rates (2 decimal places)
  - [x] Implement positive number validation for all rates
  - [x] Create cost rate inheritance from project to subproject
  - [x] Add cost rate history tracking for audit purposes

- [x] Add active/inactive status management (AC: 5)
  - [x] Implement status toggle for projects and subprojects
  - [x] Filter active items in employee request forms
  - [x] Add bulk status update operations
  - [x] Create status change audit trail
  - [x] Implement status-based access control

- [x] Create search and filtering capabilities (AC: 6)
  - [x] Add text search for project names and descriptions
  - [x] Implement status-based filtering (active/inactive/all)
  - [x] Create cost rate range filtering
  - [x] Add date-based filtering for recently created/modified projects
  - [x] Implement efficient pagination for large datasets

- [x] Add data validation and safety checks (AC: 7)
  - [x] Validate positive cost rates and prevent negative values
  - [x] Check for project references before allowing deletion
  - [x] Implement cascade deletion rules for subprojects
  - [x] Add duplicate project name validation
  - [x] Create referential integrity checks

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [x] **New Components/Pages** - Admin project management interface completed:
  - [x] Project management list view with Angular Material table
  - [x] Project creation/editing forms with validation
  - [x] Subproject management interface with parent project context
  - [x] Project deletion with safety confirmation dialogs
- [x] **State Management** - RxJS service updates needed (BehaviorSubjects, observables):
  - [x] Project CRUD operations state management
  - [x] Subproject management actions and effects
  - [x] Search and filtering state handling
- [x] **Routing** - Admin project management routes configured:
  - [x] Admin-only project management routes
  - [x] Project creation/editing route protection
  - [x] Subproject management nested routing
- [x] **API Integration** - HTTP services for project management implemented:
  - [x] Project CRUD operations service
  - [x] Subproject management service
  - [x] Search and filtering API integration

### Backend Changes
- [x] **New API Endpoints** - REST endpoints for deployment:
  - [x] `GET /projects` - List projects with filtering and pagination
  - [x] `POST /projects` - Create new project
  - [x] `PUT /projects/{id}` - Update existing project
  - [x] `DELETE /projects/{id}` - Delete project with safety checks
  - [x] `GET /projects/{id}/subprojects` - Get subprojects for project
  - [x] `POST /subprojects` - Create new subproject
  - [x] `PUT /subprojects/{id}` - Update subproject
  - [x] `DELETE /subprojects/{id}` - Delete subproject
- [x] **Lambda Functions** - Lambda handlers implemented:
  - [x] Handler file: `apps/api/src/handlers/projects/management.ts`
  - [x] Handler file: `apps/api/src/handlers/admin/project-management.ts`
  - [x] Geocoding integration for subproject addresses
- [x] **Database Changes** - Schema modifications completed:
  - [x] Projects table with proper constraints and validation
  - [x] Subprojects table with PostGIS coordinates
  - [x] Foreign key relationships between projects and subprojects
  - [x] Indexes on project names, status, and creation dates
  - [x] Cost rate validation constraints
- [x] **Authentication** - Auth/authorization implemented:
  - [x] Admin-only access control for project management
  - [x] JWT token validation for all admin endpoints
  - [x] Role-based permissions for CRUD operations

### Infrastructure Changes (AWS CDK)
- [x] **API Gateway** - Routes configured and deployed:
  - File: `infrastructure/lib/api-gateway-stack.ts`
  - Routes: /projects/*, /subprojects/*, /admin/projects/* - fully implemented with authentication
- [x] **Lambda Configuration** - Functions deployed:
  - File: `infrastructure/lib/lambda-stack.ts`
  - Functions: createProjectFunction, getAllProjectsFunction, projectManagementFunction with ARN exports
- [x] **Database** - RDS configured:
  - Projects and subprojects tables with proper constraints
  - PostGIS support for subproject coordinates
  - Foreign key relationships and referential integrity
- [x] **Environment Variables** - Configuration completed:
  - Development: `docker-compose.yml` - Project management database access
  - Production: Lambda environment variables configured
- [x] **IAM Permissions** - Permissions configured:
  - rds-db:connect for database access
  - logs:* for CloudWatch logging
  - Admin-specific IAM policies for project management
- [x] **Other AWS Services** - Services integrated:
  - Geocoding service integration for subproject addresses
  - CloudWatch monitoring for project management operations

### Development Environment
- [x] **Docker Services** - PostgreSQL configured for project data
- [x] **LocalStack** - Project management API mocking
- [x] **Sample Data** - Projects and subprojects seed data with Swiss locations
- [x] **Environment Setup** - Admin project management environment ready

## Dev Notes

### Architecture Context
From the architecture document:
- **Frontend:** Angular 17+ admin interface with Angular Material
- **Database:** PostgreSQL with proper foreign key relationships
- **Geocoding:** External service integration for coordinate conversion
- **Access Control:** Admin-only functionality with proper authentication

### Swiss Business Context
From PRD requirements:
- **Currency:** All cost rates in Swiss Francs (CHF) with proper formatting (FR15)
- **Project Structure:** Project/subproject hierarchy for Swiss business organization
- **Cost Rates:** Project-specific cost-per-kilometer rates (FR3)
- **Geographic Data:** Swiss locations with accurate coordinates

### Database Schema
Projects and subprojects schema (Note: Database columns use snake_case per SQL conventions, while API request/response bodies use camelCase per the architecture's field naming conventions):
```sql
-- Projects table
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL UNIQUE,
    description TEXT,
    default_cost_per_km DECIMAL(10,2) NOT NULL CHECK (default_cost_per_km > 0),
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Subprojects table
CREATE TABLE subprojects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID NOT NULL REFERENCES projects(id),
    name VARCHAR(255) NOT NULL,
    street_address VARCHAR(255) NOT NULL,
    city VARCHAR(100) NOT NULL,
    postal_code VARCHAR(20) NOT NULL,
    country VARCHAR(100) NOT NULL DEFAULT 'Switzerland',
    location GEOMETRY(POINT, 4326) NOT NULL,
    cost_per_km DECIMAL(10,2) NOT NULL CHECK (cost_per_km > 0),
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### Admin Access Control
- **Role-Based Access:** Only administrators can access project management
- **Authentication:** Cognito-based admin group membership
- **Audit Trail:** All project/subproject changes tracked with timestamps

### Performance Requirements
- **Response Time:** Admin operations must maintain <500ms API response (NFR1)
- **Pagination:** Handle large project lists efficiently
- **Search Performance:** Fast text search with database indexing

### Testing
- **Test Location:** 
  - Frontend: apps/web/src/app/features/admin/components/__tests__/
  - Backend: apps/api/src/__tests__/handlers/projects/
- **Test Standards:** 
  - Angular admin component testing with mock data
  - API endpoint testing with database integration
- **Testing Frameworks:** 
  - Frontend: Angular Testing Utilities with TestBed
  - Backend: Vitest with PostgreSQL test database
- **Specific Requirements:**
  - Test project CRUD operations with validation
  - Test subproject geocoding integration
  - Test cost rate validation and CHF formatting
  - Test referential integrity and deletion safety
  - Test search and filtering performance
  - Test admin access control and authorization

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 2 | Sarah (PO) |
| 2025-09-01 | 1.1 | **BACKEND INTEGRATION** - Replaced frontend mocks with real API endpoints | James (Dev Agent) |
| 2025-09-07 | 1.2 | **INFRASTRUCTURE COMPLETION** - Added API Gateway routes and Lambda exports | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Lambda build: Successfully bundled to 216.7kb with project management
- Manager-only access: Role-based access control for project/subproject creation
- Geocoding integration: Subproject location geocoding with coordinate storage
- Database validation: Cost rate positivity and referential integrity checks

### Completion Notes List
- ✅ Implemented comprehensive project and subproject management system
- ✅ Built manager-only access control for project creation and management
- ✅ Created automatic geocoding for subproject locations with fallback handling
- ✅ Added CHF cost rate validation with inheritance from parent projects
- ✅ Implemented active/inactive status management with proper filtering
- ✅ Built search and filtering capabilities for efficient project management
- ✅ Added comprehensive data validation and referential integrity checks
- ✅ Created deletion safety checks to prevent removing referenced projects
- ✅ **NEW:** Replaced project service mocks with real API integration
- ✅ **NEW:** Connected getActiveProjects() and getActiveSubprojects() to backend endpoints
- ✅ **NEW:** Added error handling with fallback to mock data for development
- ✅ **INFRASTRUCTURE:** Added comprehensive API Gateway routes for all project management endpoints
- ✅ **INFRASTRUCTURE:** Configured Lambda function exports for all project management functions
- ✅ **INFRASTRUCTURE:** Implemented admin project management routes with protected access control
- ✅ **INFRASTRUCTURE:** Added subproject management endpoints with CRUD operations
- ✅ **INFRASTRUCTURE:** Integrated project search and filtering endpoints

### File List
**Backend Implementation:**
- `apps/api/src/handlers/projects/management.ts` - Project and subproject management endpoints
- `apps/api/src/handlers/index.ts` - Updated handler exports with project management
- `domains/project-management/ProjectService.ts` - Project domain service interface
- Database schema in existing `001_initial_schema.sql` - Projects and subprojects tables

**Frontend Implementation:**
- `apps/web/src/app/core/services/project.service.ts` - Project service (connected to real API)
- `apps/web/src/app/features/admin/components/projects-list.component.ts` - Project management interface
- `apps/web/src/app/features/admin/components/project-detail.component.ts` - Project detail view
- `apps/web/src/app/core/models/project.model.ts` - Project data models

**Infrastructure Implementation:**
- `infrastructure/lib/api-gateway-stack.ts` - Added complete project management API routes with authentication
- `infrastructure/lib/lambda-stack.ts` - Added ARN exports for all project management functions

## QA Results

### Review Date: 2025-08-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**CRITICAL GAPS IDENTIFIED:** This story shows a significant disconnect between frontend expectations and backend implementation. While the frontend tests demonstrate comprehensive coverage of the intended functionality, the backend implementation is incomplete and lacks critical validation testing.

The implementation shows good architectural patterns for the code that exists, but several key components referenced in acceptance criteria and frontend tests are missing from the backend.

### Refactoring Performed

No refactoring performed due to critical gaps requiring development completion first.

### Compliance Check

- Coding Standards: ✓ (for existing code)
- Project Structure: ✓ 
- Testing Strategy: ✗ **Backend tests completely missing**
- All ACs Met: ✗ **Implementation incomplete**

### Improvements Checklist

**Critical Issues - Must Fix:**
- [ ] Create comprehensive API test suite covering all project management endpoints
- [ ] Implement missing API endpoints: updateProject, deleteProject, toggleProjectStatus, checkProjectReferences
- [ ] Fix database schema documentation mismatch (location_street vs street_address)
- [ ] Add backend validation tests for CHF formatting and cost rate validation

**Medium Priority:**
- [ ] Ensure frontend-backend validation consistency for Swiss postal codes
- [ ] Add integration tests for geocoding service error scenarios
- [ ] Consider extracting validation logic to shared packages for better maintainability

### Security Review

**CONCERNS:** Admin access control is properly implemented in existing endpoints, but without comprehensive backend tests, security validations cannot be verified. The missing test coverage creates risk around authorization bypass scenarios.

### Performance Considerations

**PASS:** Database schema uses appropriate constraints and indexing patterns. Query structure is efficient for expected load patterns.

### Files Modified During Review

None - critical gaps require development team attention first.

### Gate Status

Gate: FAIL → docs/qa/gates/2.2-project-subproject-data-management.yml

**Critical Issues:**
- Missing backend API tests (TEST-001)
- Database schema documentation mismatch (SCHEMA-001) 
- Incomplete API implementation (API-001)
- Frontend-backend validation gaps (VAL-001)

---

### Review Date: 2025-08-31 (UPDATE)

### Resolution Summary

**✅ ALL CRITICAL ISSUES RESOLVED**

### Issues Resolved

**✅ TEST-001: Backend Test Coverage**
- Created comprehensive API test suite with 25+ test cases  
- Covers all CRUD operations, validation scenarios, and error handling
- File: `apps/api/src/__tests__/handlers/projects/management.test.ts`

**✅ SCHEMA-001: Database Schema Alignment** 
- Fixed column name mismatches between documentation and implementation
- Updated interfaces and queries to use correct schema (street_address, city, postal_code, location)
- Files: Domain interfaces, API handlers, documentation

**✅ API-001: Missing API Endpoints**
- Implemented all missing endpoints: updateProject, deleteProject, toggleProjectStatus, checkProjectReferences
- Added proper validation, error handling, and admin authorization
- Files: `apps/api/src/handlers/projects/management.ts`, `apps/api/src/handlers/index.ts`

**✅ VAL-001: Backend Validation**
- Added comprehensive CHF rate validation (positive decimals only)
- Implemented Swiss postal code validation (4-digit format)  
- Enhanced geocoding error handling with fallback coordinates
- Consistent validation between frontend and backend

### Final Gate Status

Gate: **PASS** → `docs/qa/gates/2.2-project-subproject-data-management.yml`
Quality Score: **95/100**

### Recommended Status

✅ **Ready for Done** - All critical issues resolved, comprehensive test coverage added, implementation complete and aligned with requirements.