# Story 2.2: Project and Subproject Data Management

## Status
Approved

## Story
**As an** administrator,
**I want** to manage projects and subprojects with locations and cost rates,
**so that** employees can select valid projects and the system can calculate accurate allowances.

## Acceptance Criteria
1. Admin interface allows creation of projects with name, description, default cost per kilometer in CHF, and active status
2. Subproject management enables adding specific work locations with addresses, coordinates, and custom cost rates
3. Geocoding automatically converts subproject addresses to coordinates for distance calculations  
4. Cost per kilometer rates accept decimal values with CHF currency formatting and validation
5. Projects and subprojects can be marked active/inactive to control availability for new requests
6. Search and filtering capabilities allow efficient management of large project lists
7. Data validation ensures positive cost rates and prevents deletion of projects referenced by existing requests

## Tasks / Subtasks
- [ ] Create project management Angular components (AC: 1)
  - [ ] Design admin project list view with Angular Material table
  - [ ] Create project creation form with name, description, cost rate, status fields
  - [ ] Implement project editing capabilities with pre-populated forms
  - [ ] Add project deletion with safety checks for referenced projects
  - [ ] Create responsive admin interface for desktop and tablet use

- [ ] Implement subproject management (AC: 2)
  - [ ] Design subproject management interface linked to parent projects
  - [ ] Create subproject form with location, address, and custom cost rate fields
  - [ ] Implement subproject-to-project relationship management
  - [ ] Add subproject location input with address autocomplete
  - [ ] Create subproject list view with parent project context

- [ ] Integrate geocoding for subprojects (AC: 3)
  - [ ] Implement automatic geocoding when subproject address is entered
  - [ ] Store subproject coordinates in PostGIS format
  - [ ] Add geocoding validation and error handling
  - [ ] Provide manual coordinate override for edge cases
  - [ ] Display map preview for subproject locations

- [ ] Implement CHF cost rate management (AC: 4)
  - [ ] Create currency input components with CHF formatting
  - [ ] Add decimal validation for cost rates (2 decimal places)
  - [ ] Implement positive number validation for all rates
  - [ ] Create cost rate inheritance from project to subproject
  - [ ] Add cost rate history tracking for audit purposes

- [ ] Add active/inactive status management (AC: 5)
  - [ ] Implement status toggle for projects and subprojects
  - [ ] Filter active items in employee request forms
  - [ ] Add bulk status update operations
  - [ ] Create status change audit trail
  - [ ] Implement status-based access control

- [ ] Create search and filtering capabilities (AC: 6)
  - [ ] Add text search for project names and descriptions
  - [ ] Implement status-based filtering (active/inactive/all)
  - [ ] Create cost rate range filtering
  - [ ] Add date-based filtering for recently created/modified projects
  - [ ] Implement efficient pagination for large datasets

- [ ] Add data validation and safety checks (AC: 7)
  - [ ] Validate positive cost rates and prevent negative values
  - [ ] Check for project references before allowing deletion
  - [ ] Implement cascade deletion rules for subprojects
  - [ ] Add duplicate project name validation
  - [ ] Create referential integrity checks

## Dev Notes

### Architecture Context
From the architecture document:
- **Frontend:** Angular 17+ admin interface with Angular Material
- **Database:** PostgreSQL with proper foreign key relationships
- **Geocoding:** External service integration for coordinate conversion
- **Access Control:** Admin-only functionality with proper authentication

### Swiss Business Context
From PRD requirements:
- **Currency:** All cost rates in Swiss Francs (CHF) with proper formatting (FR15)
- **Project Structure:** Project/subproject hierarchy for Swiss business organization
- **Cost Rates:** Project-specific cost-per-kilometer rates (FR3)
- **Geographic Data:** Swiss locations with accurate coordinates

### Database Schema
Projects and subprojects schema:
```sql
-- Projects table
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL UNIQUE,
    description TEXT,
    default_cost_per_km DECIMAL(10,2) NOT NULL CHECK (default_cost_per_km > 0),
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Subprojects table
CREATE TABLE subprojects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID NOT NULL REFERENCES projects(id),
    name VARCHAR(255) NOT NULL,
    location_street VARCHAR(255),
    location_city VARCHAR(100),
    location_postal_code VARCHAR(20),
    location_coordinates GEOMETRY(POINT, 4326),
    cost_per_km DECIMAL(10,2) CHECK (cost_per_km > 0),
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### Admin Access Control
- **Role-Based Access:** Only administrators can access project management
- **Authentication:** Cognito-based admin group membership
- **Audit Trail:** All project/subproject changes tracked with timestamps

### Performance Requirements
- **Response Time:** Admin operations must maintain <500ms API response (NFR1)
- **Pagination:** Handle large project lists efficiently
- **Search Performance:** Fast text search with database indexing

### Testing
- **Test Location:** 
  - Frontend: apps/web/src/app/features/admin/components/__tests__/
  - Backend: apps/api/src/__tests__/handlers/projects/
- **Test Standards:** 
  - Angular admin component testing with mock data
  - API endpoint testing with database integration
- **Testing Frameworks:** 
  - Frontend: Angular Testing Utilities with TestBed
  - Backend: Vitest with PostgreSQL test database
- **Specific Requirements:**
  - Test project CRUD operations with validation
  - Test subproject geocoding integration
  - Test cost rate validation and CHF formatting
  - Test referential integrity and deletion safety
  - Test search and filtering performance
  - Test admin access control and authorization

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 2 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*