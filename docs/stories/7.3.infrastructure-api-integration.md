# Story 7.3: infrastructure-api-integration

## Status
Accepted

## Story
**As a** developer,
I want **the translation infrastructure properly configured and deployed**,
so that **multilingual features work reliably in all environments with proper monitoring**.

## Acceptance Criteria
1. **Lambda Function Deployment**: Deploy TranslateMasterData Lambda with AWS Translate permissions
2. **API Gateway Integration**: Add `/api/translate-master-data` endpoint with Cognito authentication
3. **Database Schema**: Deploy master_data_translations table with proper indexes and cleanup functions
4. **Environment Configuration**: Configure translation service across dev/staging/production environments
5. **IAM Permissions**: Proper AWS Translate permissions and database access for Lambda function
6. **Monitoring Setup**: CloudWatch logging and metrics for translation performance
7. **Cost Optimization**: Translation request monitoring and cache hit rate tracking

## Tasks / Subtasks

- [ ] Task 1: Deploy Lambda Function Infrastructure (AC: 1)
  - [ ] Add TranslateMasterData function to `infrastructure/src/lambda-stack.ts`
  - [ ] Configure function memory allocation (256-512MB) and timeout (30s)
  - [ ] Set up environment variables (AWS_REGION, DATABASE_URL)
  - [ ] Export Lambda ARN for API Gateway integration

- [ ] Task 2: Configure API Gateway Integration (AC: 2)
  - [ ] Add Lambda import in `infrastructure/src/api-gateway-stack.ts`
  - [ ] Create POST `/api/translate-master-data` route with Cognito authorizer
  - [ ] Configure CORS settings for translation endpoint
  - [ ] Add request validation schema for translation requests

- [ ] Task 3: Deploy Database Schema Changes (AC: 3)
  - [ ] Create migration script for `master_data_translations` table
  - [ ] Deploy performance indexes (lookup and expiry optimization)
  - [ ] Implement cleanup function `cleanup_expired_master_data_translations()`
  - [ ] Add database deployment to infrastructure pipeline

- [ ] Task 4: Configure Multi-Environment Support (AC: 4)
  - [ ] Configure dev environment with AWS Translate service
  - [ ] Configure staging environment with production-like settings
  - [ ] Configure production environment with cost optimization
  - [ ] Add environment-specific translation service configuration

- [ ] Task 5: Implement IAM Permissions (AC: 5)
  - [ ] Add AWS Translate permissions to Lambda execution role
  - [ ] Configure `translate:TranslateText` and `translate:ListLanguages` actions
  - [ ] Set up database access permissions for Lambda function
  - [ ] Implement least-privilege permission model

- [ ] Task 6: Set Up CloudWatch Monitoring (AC: 6)
  - [ ] Configure CloudWatch log groups for translation service
  - [ ] Implement custom metrics for translation performance
  - [ ] Add error tracking and performance monitoring
  - [ ] Set up log retention and cleanup policies

- [ ] Task 7: Implement Cost Optimization Monitoring (AC: 7)
  - [ ] Add translation request volume metrics
  - [ ] Implement cache hit rate tracking
  - [ ] Configure cost threshold alerting for AWS Translate usage
  - [ ] Add performance dashboard for translation service

- [ ] Task 8: Environment Testing and Validation
  - [ ] Test Lambda deployment in dev environment
  - [ ] Validate API Gateway endpoint functionality
  - [ ] Test database schema deployment and cleanup
  - [ ] Perform end-to-end translation flow validation

- [ ] Task 9: Infrastructure Documentation
  - [ ] Document deployment procedures for translation service
  - [ ] Update CLAUDE.md with new infrastructure requirements
  - [ ] Document monitoring and alerting configuration
  - [ ] Create troubleshooting guide for translation service

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [ ] **New Components/Pages** - No new frontend components required
- [ ] **State Management** - No new RxJS service updates needed
- [ ] **Routing** - No new routes or route guards required
- [ ] **API Integration** - No new HTTP service methods needed (uses existing from Story 7.2)

### Backend Changes
- [x] **New API Endpoints** - Infrastructure deployment for existing endpoint:
  - [x] `POST /api/translate-master-data` - Infrastructure deployment and configuration
- [x] **Lambda Functions** - Infrastructure deployment for existing handler:
  - [x] Handler already created in Story 7.2: `apps/api/src/handlers/translation/translate-master-data.ts`
- [x] **Database Changes** - Schema deployment and migration:
  - [x] Migration script deployment: Production database schema updates
  - [x] Tables/indexes: `master_data_translations` with performance indexes
- [x] **Authentication** - Infrastructure configuration:
  - [x] Cognito authorizer configuration for translation endpoint

### Infrastructure Changes (AWS CDK)
- [x] **API Gateway** - New routes/methods/cors:
  - File: `infrastructure/src/api-gateway-stack.ts` - Add POST route with authentication
- [x] **Lambda Configuration** - Function definitions and permissions:
  - File: `infrastructure/src/lambda-stack.ts` - Add translateMasterDataFunction
- [x] **Database** - RDS changes and migrations:
  - Database deployment of master_data_translations table and indexes
- [x] **Environment Variables** - New config needed:
  - Production: AWS_REGION, DATABASE_URL configuration for translation service
- [x] **IAM Permissions** - New service permissions:
  - AWS Translate permissions: translate:TranslateText, translate:ListLanguages
- [x] **Other AWS Services** - AWS Translate service integration:
  - CloudWatch logging and metrics configuration

### Development Environment
- [x] **Docker Services** - LocalStack configuration:
  - Configure LocalStack with AWS Translate mocking (may require Pro features)
- [x] **LocalStack** - New mocked AWS services:
  - AWS Translate service mocking for local development
- [x] **Sample Data** - Database seed updates:
  - Add sample translation cache data for testing
- [x] **Environment Setup** - New setup steps:
  - Document LocalStack AWS Translate configuration requirements

## Dev Notes

### Technical Design Notes

**Infrastructure Deployment Architecture**:
This story focuses exclusively on the infrastructure deployment, configuration, and monitoring aspects of the multilingual translation system. The actual Lambda handlers and frontend services were implemented in Stories 7.1 and 7.2 - this story ensures they are properly deployed and monitored in all environments.

**AWS CDK Stack Integration** [Source: docs/architecture/02-infrastructure-deployment.md]:
```typescript
// LambdaStack configuration
const translateMasterDataFunction = new Function(this, 'TranslateMasterDataFunction', {
  functionName: `${stackName}-translate-master-data`,
  runtime: Runtime.NODEJS_18_X,
  handler: 'handlers/translation/translate-master-data.translateMasterDataHandler',
  code: Code.fromAsset('dist/api'),
  memorySize: 512,  // Optimized for translation workload
  timeout: Duration.seconds(30),
  environment: {
    NODE_ENV: environment,
    AWS_REGION: this.region,
    DATABASE_URL: databaseUrl
  }
});

// IAM permissions for AWS Translate
translateMasterDataFunction.addToRolePolicy(new PolicyStatement({
  effect: Effect.ALLOW,
  actions: [
    'translate:TranslateText',
    'translate:ListLanguages'
  ],
  resources: ['*']
}));
```

**API Gateway Integration** [Source: docs/architecture/02-infrastructure-deployment.md]:
```typescript
// API Gateway route configuration
const translateResource = api.root.addResource('translate-master-data');
translateResource.addMethod('POST', new LambdaIntegration(translateMasterDataFunction), {
  authorizationType: AuthorizationType.COGNITO,
  authorizer: cognitoAuthorizer,
  requestValidator: requestValidator,
  requestModels: {
    'application/json': translationRequestModel
  }
});
```

**Database Schema Deployment** [Source: docs/architecture/03-data-architecture.md]:
```sql
-- Migration script: Add master_data_translations table
CREATE TABLE IF NOT EXISTS master_data_translations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  original_text TEXT NOT NULL,
  translated_text TEXT NOT NULL,
  source_language VARCHAR(2) DEFAULT 'auto',
  target_language VARCHAR(2) NOT NULL CHECK (target_language IN ('de', 'fr', 'it', 'en')),
  context VARCHAR(50) NOT NULL,
  confidence_score DECIMAL(3,2) CHECK (confidence_score >= 0 AND confidence_score <= 1),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '24 hours'),
  UNIQUE(original_text, target_language, context)
);

-- Performance indexes
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_master_data_translations_lookup
ON master_data_translations(original_text, target_language, context);

CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_master_data_translations_expiry
ON master_data_translations(expires_at);

-- Cleanup function
CREATE OR REPLACE FUNCTION cleanup_expired_master_data_translations()
RETURNS void AS $$
BEGIN
  DELETE FROM master_data_translations WHERE expires_at < NOW();
END;
$$ LANGUAGE plpgsql;
```

**Multi-Environment Configuration** [Source: docs/architecture/02-infrastructure-deployment.md]:
- **Development**: LocalStack with mocked AWS Translate service
- **Staging**: Production-like AWS Translate with cost monitoring
- **Production**: Full AWS Translate with comprehensive monitoring and alerting

**Monitoring and Observability Implementation** [Source: docs/architecture/08-operations-security.md]:
```typescript
// Custom CloudWatch metrics for translation service
export class TranslationMetrics {
  private cloudwatch = new CloudWatch();

  async recordTranslationRequest(targetLanguage: string, cached: boolean): Promise<void> {
    await this.cloudwatch.putMetricData({
      Namespace: 'RegularTravelManager/Translation',
      MetricData: [{
        MetricName: 'TranslationRequests',
        Value: 1,
        Unit: 'Count',
        Dimensions: [
          { Name: 'TargetLanguage', Value: targetLanguage },
          { Name: 'Cached', Value: cached.toString() },
          { Name: 'Environment', Value: process.env.NODE_ENV || 'development' }
        ]
      }]
    }).promise();
  }

  async recordCacheHitRate(hitRate: number): Promise<void> {
    await this.cloudwatch.putMetricData({
      Namespace: 'RegularTravelManager/Translation',
      MetricData: [{
        MetricName: 'CacheHitRate',
        Value: hitRate,
        Unit: 'Percent'
      }]
    }).promise();
  }
}
```

**Cost Optimization Monitoring** [Source: docs/architecture/08-operations-security.md]:
```yaml
# CloudWatch Alarms for translation service
alarms:
  high_translation_cost:
    metric: AWS/Translate/CharacterCount
    threshold: 100000  # 100K characters per hour
    period: 3600
    evaluation_periods: 1

  low_cache_hit_rate:
    metric: Custom/Translation/CacheHitRate
    threshold: 70  # Below 70% cache hit rate
    period: 900
    evaluation_periods: 2

  translation_service_errors:
    metric: AWS/Lambda/Errors
    function_name: rtm-translate-master-data
    threshold: 5
    period: 300
    evaluation_periods: 1
```

**Regional Deployment Strategy** [Source: docs/architecture/02-infrastructure-deployment.md]:
- **AWS Translate Region**: eu-central-1 (Frankfurt) for Swiss data residency compliance
- **Database Region**: Same region as existing infrastructure (eu-central-1)
- **CloudWatch Metrics**: Regional monitoring with centralized dashboard

**Performance Optimization Configuration**:
- **Lambda Memory**: 256-512MB based on translation workload requirements
- **Lambda Timeout**: 30 seconds for AWS Translate API calls with retry logic
- **Database Connection Pooling**: Reuse existing PostgreSQL connection pool
- **Cache Strategy**: Multi-level caching with PostgreSQL (24h) + memory cache

### Testing Standards

**Testing Framework and Patterns** [Source: docs/architecture/07-development-standards.md]:
- **Infrastructure Testing**: AWS CDK synthesis and deployment validation
- **Integration Testing**: End-to-end service deployment and functionality testing
- **Monitoring Testing**: CloudWatch metrics and alerting validation

**Infrastructure Testing Requirements**:
- **CDK Synthesis**: `npm run infrastructure:plan` validation for all environments
- **Deployment Testing**: Validate Lambda function deployment and permissions
- **API Gateway Testing**: Validate endpoint configuration and authentication
- **Database Testing**: Validate schema deployment and index performance

**Testing Patterns**:
- **LocalStack Integration**: Test AWS Translate service mocking in development
- **Environment Validation**: Test deployment across dev/staging/production
- **Monitoring Validation**: Test CloudWatch metrics and alerting functionality
- **Performance Testing**: Validate Lambda performance and cost optimization

## Definition of Done Checklist

### Development Complete
- [ ] All acceptance criteria implemented
- [ ] Infrastructure code tested and validated
- [ ] Integration tests cover deployment functionality
- [ ] Code follows project conventions
- [ ] Infrastructure documentation updated

### Infrastructure Complete ⚠️ CRITICAL
- [ ] All infrastructure changes implemented in CDK
- [ ] CDK diff reviewed and approved (`npm run infrastructure:plan`)
- [ ] Environment variables configured (dev + prod)
- [ ] IAM permissions validated (AWS Translate access)
- [ ] API Gateway routes deployed and tested
- [ ] Lambda functions deployed and tested
- [ ] Database migrations applied successfully
- [ ] Infrastructure validation passes (`npm run infrastructure:validate`)

### Review Ready
- [ ] PR created with infrastructure checklist completed
- [ ] Code review completed
- [ ] Infrastructure review completed
- [ ] Documentation updated (CLAUDE.md, deployment procedures)
- [ ] Monitoring dashboards configured and validated

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-25 | 1.0 | Initial story creation with comprehensive infrastructure focus | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- Populated by development agent -->

### Debug Log References
<!-- Populated by development agent -->

### Completion Notes List
<!-- Populated by development agent -->

### File List
<!-- Populated by development agent -->

## QA Results
<!-- Results from QA Agent review -->