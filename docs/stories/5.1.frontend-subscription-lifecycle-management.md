# Story 5.1: Frontend Subscription Lifecycle Management

## Status
Draft

## Story
**As a** user (employee, manager, or admin),
**I want** all HTTP requests and subscriptions to be properly cleaned up when I log out,
**so that** I don't receive unauthorized error messages and the application maintains clean state after logout.

## Acceptance Criteria
1. **AC1**: When a user logs out, all active HTTP subscriptions are immediately cancelled and cleaned up
2. **AC2**: No "unauthorized" or "forbidden" error messages appear after logout is complete
3. **AC3**: Background refresh calls and auto-refresh timers are properly stopped during logout
4. **AC4**: Component subscriptions use proper lifecycle management with `takeUntil(destroy$)` pattern
5. **AC5**: Service-level background operations are cancelled during authentication state changes
6. **AC6**: All subscription leaks are eliminated to prevent memory leaks and persistent HTTP requests
7. **AC7**: Error handling distinguishes between expected logout errors vs unexpected auth failures

## Tasks / Subtasks
- [ ] **Task 1: Fix Travel Request Form Component Subscription Management** (AC: 1, 4, 6)
  - [ ] Add `takeUntil(this.destroy$)` to project form subscription (line 152)
  - [ ] Add `takeUntil(this.destroy$)` to `loadSubprojects()` subscription (line 189)
  - [ ] Add `takeUntil(this.destroy$)` to `loadProjects()` and `loadManagers()` Promise-based subscriptions (lines 107, 132)
  - [ ] Add `takeUntil(this.destroy$)` to retry action subscriptions in error handlers (lines 121, 276)
  - [ ] Verify all HTTP calls in the component use proper lifecycle management

- [ ] **Task 2: Fix Project Service Background Refresh Calls** (AC: 1, 3, 5)
  - [ ] Modify `refreshProjects()` method to accept optional destruction signal parameter
  - [ ] Update all `tap(() => this.refreshProjects())` calls to include proper lifecycle management
  - [ ] Add error handling that respects component lifecycle and suppresses expected auth errors
  - [ ] Implement service-level subscription cleanup mechanism

- [ ] **Task 3: Fix Manager Dashboard Auto-refresh Cleanup** (AC: 3, 5)
  - [ ] Ensure `stopAutoRefresh()` is called during logout flow in auth service
  - [ ] Add explicit cleanup mechanism that can be triggered externally
  - [ ] Make the service lifecycle-aware for logout scenarios
  - [ ] Add proper error handling for auth failures in auto-refresh subscriptions

- [ ] **Task 4: Enhance Auth Service Logout Process** (AC: 1, 2, 5)
  - [ ] Add global subscription cleanup mechanism during logout
  - [ ] Implement immediate cancellation of pending requests during logout process
  - [ ] Add cleanup verification to ensure all subscriptions are properly destroyed
  - [ ] Update logout method to stop all service-level background operations

- [ ] **Task 5: Improve Error Handling Strategy** (AC: 2, 7)
  - [ ] Enhance error interceptor to distinguish expected logout errors vs failures
  - [ ] Implement request context tracking to suppress expected post-logout errors
  - [ ] Add debugging capabilities to trace persistent request sources
  - [ ] Update error messages to be context-aware of authentication state

- [ ] **Task 6: Testing and Validation** (AC: 1-7)
  - [ ] Test logout with various active request scenarios (form submissions, background refreshes)
  - [ ] Verify subscription cleanup in all components using browser dev tools
  - [ ] Validate error suppression works correctly for expected logout errors
  - [ ] Ensure no memory leaks from persistent subscriptions
  - [ ] Test with different user roles and multiple concurrent sessions

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [x] **New Components/Pages** - No new components needed, fixing existing ones:
  - TravelRequestFormComponent - subscription lifecycle fixes
  - Manager dashboard components - cleanup integration
- [x] **State Management** - RxJS service updates needed (BehaviorSubjects, observables):
  - ProjectService - background refresh lifecycle management
  - ManagerDashboardService - auto-refresh cleanup integration
  - AuthService - global subscription cleanup mechanism
- [ ] **Routing** - New routes or route guards required: None
- [x] **API Integration** - New HTTP service methods needed:
  - Enhanced error handling in existing HTTP service methods
  - Request cancellation capabilities in service methods

### Backend Changes
- [ ] **New API Endpoints** - No new REST endpoints needed
- [ ] **Lambda Functions** - No new Lambda handlers required
- [ ] **Database Changes** - No schema modifications needed
- [ ] **Authentication** - No auth/authorization changes needed

### Infrastructure Changes (AWS CDK)
- [ ] **API Gateway** - No new routes/methods/cors needed
- [ ] **Lambda Configuration** - No function definition changes needed
- [ ] **Database** - No RDS changes or migrations needed
- [ ] **Environment Variables** - No new config needed
- [ ] **IAM Permissions** - No new service permissions needed
- [ ] **Other AWS Services** - No S3, SES, etc. changes needed

### Development Environment
- [ ] **Docker Services** - No new services in docker-compose.yml needed
- [ ] **LocalStack** - No new mocked AWS services needed
- [ ] **Sample Data** - No database seed updates needed
- [ ] **Environment Setup** - No new setup steps required

## Dev Notes

### Technical Design Notes

**Problem Root Cause Analysis:**
Based on comprehensive code review, the issue stems from inconsistent subscription lifecycle management across the Angular frontend. Multiple components and services have subscriptions that persist after component destruction and continue executing after logout, causing "unauthorized" error floods.

**Critical Issues Identified:**
1. **TravelRequestFormComponent** - Several subscriptions missing `takeUntil(this.destroy$)` pattern
2. **ProjectService** - Background `refreshProjects()` calls lack lifecycle management
3. **ManagerDashboardService** - Auto-refresh timer not properly cleaned up during logout
4. **AuthInterceptor** - Processes requests even after logout instead of cancelling them

**Implementation Strategy - 3-Phase Approach:**

**Phase 1: Component-Level Fixes (Immediate Impact)**
- Fix subscription leaks in TravelRequestFormComponent by adding `takeUntil(this.destroy$)` to all HTTP subscriptions
- Update ProjectService to include destruction signals in background operations
- Integrate manager dashboard cleanup with auth service logout flow

**Phase 2: Service-Level Architecture (Systematic Cleanup)**
- Implement global subscription registry in AuthService for automatic cleanup
- Add request cancellation mechanism using AbortController
- Enhance error interceptor with context-aware error suppression

**Phase 3: Prevention & Monitoring (Long-term Maintenance)**
- Create subscription management utilities for consistent lifecycle handling
- Add development-time warnings for unmanaged subscriptions
- Implement request lifecycle debugging capabilities

**RxJS Patterns to Follow (from Architecture):**
```typescript
// Correct Pattern - All HTTP subscriptions must use this
private destroy$ = new Subject<void>();

ngOnInit(): void {
  this.service.getData()
    .pipe(takeUntil(this.destroy$))
    .subscribe(data => { /* handle data */ });
}

ngOnDestroy(): void {
  this.destroy$.next();
  this.destroy$.complete();
}
```

**State Management Integration:**
All services using BehaviorSubjects must implement proper cleanup during logout:
- Clear state subjects during logout
- Cancel pending HTTP requests
- Stop timer-based operations
- Notify dependent components of state reset

**Error Handling Strategy:**
- Distinguish between expected logout errors (401/403 after user.logout) vs unexpected auth failures
- Suppress error notifications for expected post-logout 401 errors
- Maintain error logging for debugging while preventing user-facing error floods

### Testing Standards

**Test File Locations:**
- Component tests: `apps/web/src/app/features/*/components/__tests__/*.spec.ts`
- Service tests: `apps/web/src/app/core/services/__tests__/*.spec.ts`
- Integration tests: `apps/web/src/app/__tests__/integration/*.spec.ts`

**Testing Framework:** Jest + Angular Testing Utilities

**Specific Testing Requirements:**
1. **Subscription Lifecycle Tests:**
   - Verify `takeUntil(destroy$)` pattern prevents memory leaks
   - Test component destruction cancels all active subscriptions
   - Validate service cleanup during logout

2. **Error Handling Tests:**
   - Test logout scenarios with active HTTP requests
   - Verify error suppression for expected auth failures
   - Validate error messages don't appear after successful logout

3. **Integration Tests:**
   - Test complete logout flow with multiple concurrent requests
   - Verify different user roles handle logout consistently
   - Test auto-refresh cleanup across different dashboard states

**Testing Patterns:**
```typescript
// Test subscription cleanup
it('should cancel all subscriptions on component destroy', () => {
  // Setup active subscriptions
  // Trigger component destroy
  // Verify no pending HTTP requests
  // Verify no memory leaks
});

// Test logout cleanup
it('should stop all background operations during logout', () => {
  // Setup background operations
  // Trigger logout
  // Verify all timers/intervals stopped
  // Verify no error notifications
});
```

## Definition of Done Checklist

### Development Complete
- [ ] All acceptance criteria implemented
- [ ] Unit tests written and passing
- [ ] Integration tests cover new functionality
- [ ] Code follows project conventions
- [ ] TypeScript types properly defined in packages/shared

### Infrastructure Complete ⚠️ CRITICAL
- [ ] All infrastructure changes implemented in CDK (N/A for this story)
- [ ] CDK diff reviewed and approved (`npm run infrastructure:plan`) (N/A)
- [ ] Environment variables configured (dev + prod) (N/A)
- [ ] IAM permissions validated (N/A)
- [ ] API Gateway routes deployed and tested (N/A)
- [ ] Lambda functions deployed and tested (N/A)
- [ ] Database migrations applied successfully (N/A)
- [ ] Infrastructure validation passes (`npm run infrastructure:validate`) (N/A)

### Review Ready
- [ ] PR created with infrastructure checklist completed
- [ ] Code review completed
- [ ] Infrastructure review completed (N/A for this story)
- [ ] Documentation updated
- [ ] CLAUDE.md updated if commands changed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-12 | 1.0 | Initial story creation for fixing frontend subscription lifecycle management and post-logout unauthorized errors | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*