# Story 5.3: Administrator User Management

## Status
Approved

## Story
**As an** administrator,
**I want** to view all registered users, manage user roles, assign managers, and control user access,
**so that** I can maintain proper organizational structure and security controls.

## Dependencies
- **Enables:** Story 5.3A (Advanced Administrator Operations) - Provides foundation for advanced capabilities

## Acceptance Criteria
1. User management dashboard displays all registered users with comprehensive search, filtering, and pagination capabilities supporting large user bases
2. Role assignment interface allows changing user roles between employee, manager, and administrator with confirmation dialogs and immediate effect
3. Manager assignment functionality enables setting and modifying reporting relationships with validation of manager role requirements and hierarchy loops
4. User account management includes activation, deactivation, and deletion capabilities with proper cleanup of associated travel requests and audit records

## Tasks / Subtasks
- [ ] Create core user management API endpoints (AC: 1, 4)
  - [ ] Build `GET /api/admin/users` Lambda function with advanced filtering and pagination
  - [ ] Build `PUT /api/admin/users/{id}/status` endpoint for activation/deactivation
  - [ ] Build `DELETE /api/admin/users/{id}` endpoint with comprehensive cleanup
  - [ ] Implement user search with multiple criteria (name, email, role, status)
  - [ ] Create transaction handling for complex user operations

- [ ] Implement role management system (AC: 2, 3)
  - [ ] Create `PUT /api/admin/users/{id}/role` endpoint with role validation
  - [ ] Build `PUT /api/admin/users/{id}/manager` endpoint with hierarchy validation
  - [ ] Implement Cognito user group synchronization for role changes
  - [ ] Add manager hierarchy loop detection and prevention
  - [ ] Create role change impact analysis and validation
  - [ ] Implement permission validation for role assignments

- [ ] Build core admin dashboard (AC: 1)
  - [ ] Create `AdminUserManagementComponent` with advanced data grid
  - [ ] Implement real-time search with debounced queries
  - [ ] Build role assignment interface with confirmation dialogs
  - [ ] Design mobile-responsive admin dashboard

- [ ] Implement data cleanup and integrity (AC: 4)
  - [ ] Create comprehensive user deletion cleanup procedures
  - [ ] Implement travel request reassignment for deleted users
  - [ ] Add audit record preservation for deleted users
  - [ ] Create manager relationship cleanup for departing managers
  - [ ] Implement data retention policies for inactive users
  - [ ] Add orphaned record detection and cleanup

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [ ] **New Components/Pages** - Core administrator dashboard with user management capabilities
- [ ] **State Management** - RxJS service updates for core admin operations:
  - [ ] `AdminService` with core user management operations
  - [ ] User list state management with BehaviorSubjects
  - [ ] Role assignment state management
- [ ] **Routing** - Admin-only protected routes with guard validation:
  - [ ] `/admin/users` - Main user management dashboard
  - [ ] `/admin/users/{id}` - Individual user details and management
- [ ] **API Integration** - HTTP services for core administrative operations:
  - [ ] User management CRUD operations
  - [ ] Role and manager assignment services

### Backend Changes
- [ ] **New API Endpoints** - Core administrative user management REST endpoints:
  - [ ] `GET /api/admin/users` - Paginated user listing with filtering
  - [ ] `GET /api/admin/users/{id}` - Detailed user information
  - [ ] `PUT /api/admin/users/{id}/role` - Role assignment with validation
  - [ ] `PUT /api/admin/users/{id}/manager` - Manager assignment with hierarchy validation
  - [ ] `PUT /api/admin/users/{id}/status` - User activation/deactivation
  - [ ] `DELETE /api/admin/users/{id}` - User deletion with cleanup
- [ ] **Lambda Functions** - Core Lambda handlers for administrative operations:
  - [ ] Handler file: `apps/api/src/handlers/admin/list-users.ts`
  - [ ] Handler file: `apps/api/src/handlers/admin/get-user-details.ts`
  - [ ] Handler file: `apps/api/src/handlers/admin/update-user-role.ts`
  - [ ] Handler file: `apps/api/src/handlers/admin/assign-manager.ts`
  - [ ] Handler file: `apps/api/src/handlers/admin/update-user-status.ts`
  - [ ] Handler file: `apps/api/src/handlers/admin/delete-user.ts`
- [ ] **Database Changes** - Core schema modifications for admin operations:
  - [ ] Migration script: `migrations/024-create-admin-core-tables.sql`
  - [ ] Core administrative tables for user management
- [ ] **Authentication** - Admin authorization with existing role system:
  - [ ] Admin-only endpoint protection with existing JWT validation
  - [ ] Enhanced role validation for administrative operations
  - [ ] Admin activity logging and monitoring

### Infrastructure Changes (AWS CDK)
- [ ] **API Gateway** - New routes for core administrative operations:
  - File: `infrastructure/lib/api-gateway-stack.ts`
  - Routes: `/admin/users/*`
- [ ] **Lambda Configuration** - Function definitions for core admin operations:
  - File: `infrastructure/lib/lambda-stack.ts`
  - Functions: `listUsersFunction`, `updateUserRoleFunction`, `assignManagerFunction`, `deleteUserFunction`
- [ ] **Database** - RDS schema updates for core admin functionality:
  - Core administrative tables for user management
- [ ] **Environment Variables** - Core administrative operation configuration:
  - Development: `docker-compose.yml` - Admin dashboard settings
  - Production: `infrastructure/lib/config/environment-config.ts` - Admin security settings
- [ ] **IAM Permissions** - Core permissions for administrative operations:
  - Cognito user management permissions
  - Database administrative access permissions
- [ ] **Other AWS Services**:
  - AWS Cognito - User pool and group management
  - CloudWatch - Administrative operation monitoring

### Development Environment
- [ ] **Docker Services** - No changes required to existing services
- [ ] **LocalStack** - Core admin dashboard testing with enhanced Cognito mocking
- [ ] **Sample Data** - Core administrative test scenarios with user hierarchies
- [ ] **Environment Setup** - Core admin dashboard workflow testing configuration

## Dev Notes

### Architecture Context
From the architecture document:
- **Role-Based Access:** Extends existing Cognito user groups with administrative capabilities
- **Data Integrity:** Maintains referential integrity across user deletion and role changes
- **Audit Compliance:** Comprehensive administrative action logging for Swiss business compliance
- **Scalability:** Supports large user bases with efficient pagination and filtering

### Existing System Integration
From brainstorming session and current implementation:
- **Authentication System:** Leverages existing JWT validation with admin role checking
- **User Groups:** Integrates with existing Cognito user groups (employees, managers, administrators)
- **Travel Requests:** Handles cleanup and reassignment of travel requests during user management
- **Email System:** Uses existing SES configuration for administrative notifications

### Security Requirements
From PRD non-functional requirements:
- **Admin Authorization:** Strict role validation for all administrative operations (NFR14)
- **Data Encryption:** All admin operations via HTTPS/TLS (NFR6)
- **Audit Trail:** Comprehensive logging of all administrative actions (NFR12)
- **Access Control:** Fine-grained permissions for different admin operations (NFR7)

### User Management Data Model
```typescript
interface AdminUserListing {
  users: UserSummary[];
  pagination: {
    currentPage: number;
    totalPages: number;
    totalUsers: number;
    pageSize: number;
  };
  filters: {
    search?: string;
    role?: UserRole;
    status?: UserStatus;
    department?: string;
    managerId?: string;
  };
  sortBy: 'name' | 'email' | 'role' | 'lastLogin' | 'registrationDate';
  sortOrder: 'asc' | 'desc';
}

interface UserSummary {
  id: string;
  employeeNumber: string;
  firstName: string;
  lastName: string;
  email: string;
  role: 'employee' | 'manager' | 'administrator';
  status: 'active' | 'inactive' | 'pending';
  managerId?: string;
  managerName?: string;
  department?: string;
  lastLoginAt?: Date;
  registrationDate: Date;
  requestCount: number;
  isVerified: boolean;
}

interface UserDetails extends UserSummary {
  phoneNumber?: string;
  homeAddress: {
    street: string;
    city: string;
    postalCode: string;
    country: string;
  };
  notificationPreferences: NotificationPreferences;
  activitySummary: UserActivitySummary;
  directReports: UserSummary[];
  recentRequests: TravelRequestSummary[];
}
```

### Role Management System
```typescript
interface RoleChangeRequest {
  userId: string;
  newRole: 'employee' | 'manager' | 'administrator';
  reason: string;
  effectiveDate?: Date;
}

interface RoleChangeValidation {
  canChangeRole: boolean;
  warnings: string[];
  impacts: RoleChangeImpact[];
  confirmationRequired: boolean;
  existingPermissions: string[];
  newPermissions: string[];
}

interface ManagerAssignmentRequest {
  userId: string;
  managerId: string;
  reason: string;
  effectiveDate?: Date;
}

interface ManagerAssignmentValidation {
  canAssignManager: boolean;
  warnings: string[];
  hierarchyImpacts: HierarchyImpact[];
  loopDetected: boolean;
  managerCapacityOk: boolean;
}
```

### Bulk Operations System
```typescript
interface BulkOperation {
  id: string;
  type: 'role_change' | 'manager_assignment' | 'status_update' | 'deactivation';
  targetUserIds: string[];
  parameters: Record<string, any>;
  status: 'pending' | 'processing' | 'completed' | 'failed' | 'partial';
  progress: {
    total: number;
    processed: number;
    successful: number;
    failed: number;
  };
  results: BulkOperationResult[];
  createdBy: string;
  createdAt: Date;
  completedAt?: Date;
  estimatedDuration?: number;
}

interface BulkOperationResult {
  userId: string;
  status: 'success' | 'error' | 'skipped';
  message?: string;
  oldValue?: any;
  newValue?: any;
}
```

### User Activity Monitoring
```typescript
interface UserActivitySummary {
  loginHistory: LoginEvent[];
  requestActivity: RequestActivitySummary;
  systemUsage: SystemUsageSummary;
  securityEvents: SecurityEvent[];
  anomalies: AnomalyDetection[];
}

interface LoginEvent {
  timestamp: Date;
  ipAddress: string;
  userAgent: string;
  location?: string;
  success: boolean;
  failureReason?: string;
}

interface RequestActivitySummary {
  totalRequests: number;
  requestsThisMonth: number;
  averageRequestValue: number;
  frequencyPattern: RequestFrequency;
  lastRequestDate?: Date;
}

interface SecurityEvent {
  type: 'suspicious_login' | 'multiple_failures' | 'unusual_activity' | 'role_escalation';
  timestamp: Date;
  severity: 'low' | 'medium' | 'high' | 'critical';
  description: string;
  resolved: boolean;
}
```

### User Deletion and Cleanup
```sql
-- Comprehensive user deletion procedure
-- Note: Database uses snake_case for column names per SQL conventions
CREATE OR REPLACE FUNCTION admin_delete_user(
  user_id UUID,
  admin_id UUID,
  deletion_reason TEXT
) RETURNS TABLE(
  cleanup_summary JSONB
) AS $$
DECLARE
  request_count INTEGER;
  audit_count INTEGER;
  cleanup_result JSONB;
BEGIN
  -- Count associated records
  SELECT COUNT(*) INTO request_count FROM travel_requests WHERE employee_id = user_id;
  SELECT COUNT(*) INTO audit_count FROM employee_profile_history WHERE employee_id = user_id;
  
  -- Archive travel requests (don't delete for audit purposes)
  UPDATE travel_requests 
  SET status = 'archived', 
      archived_at = CURRENT_TIMESTAMP,
      archived_by = admin_id
  WHERE employee_id = user_id AND status != 'approved';
  
  -- Reassign approved requests to system account for historical reference
  UPDATE travel_requests 
  SET employee_note = CONCAT('Original employee deleted: ', employee_note),
      archived_by = admin_id
  WHERE employee_id = user_id AND status = 'approved';
  
  -- Archive profile history (preserve for compliance)
  UPDATE employee_profile_history 
  SET archived_at = CURRENT_TIMESTAMP 
  WHERE employee_id = user_id;
  
  -- Update manager relationships for direct reports
  UPDATE employees 
  SET manager_id = NULL,
      profile_updated_at = CURRENT_TIMESTAMP
  WHERE manager_id = user_id;
  
  -- Soft delete employee record (preserve for audit)
  UPDATE employees 
  SET is_active = FALSE,
      deleted_at = CURRENT_TIMESTAMP,
      deleted_by = admin_id,
      deletion_reason = deletion_reason
  WHERE id = user_id;
  
  -- Create cleanup summary
  SELECT jsonb_build_object(
    'user_id', user_id,
    'travel_requests_archived', request_count,
    'audit_records_preserved', audit_count,
    'direct_reports_updated', (SELECT COUNT(*) FROM employees WHERE manager_id IS NULL),
    'deleted_at', CURRENT_TIMESTAMP
  ) INTO cleanup_result;
  
  RETURN QUERY SELECT cleanup_result;
END;
$$ LANGUAGE plpgsql;
```

### Administrative Reporting
```typescript
interface AdminReport {
  type: 'user_summary' | 'role_distribution' | 'activity_analysis' | 'security_audit';
  parameters: ReportParameters;
  format: 'csv' | 'pdf' | 'json' | 'excel';
  filters: ReportFilters;
  generatedAt: Date;
  generatedBy: string;
}

interface UserSummaryReport {
  totalUsers: number;
  activeUsers: number;
  pendingUsers: number;
  roleDistribution: RoleCount[];
  registrationTrends: RegistrationTrend[];
  departmentBreakdown: DepartmentStats[];
  managerHierarchy: ManagerHierarchyStats;
}

interface SecurityAuditReport {
  period: DateRange;
  loginAttempts: LoginAttemptStats;
  securityEvents: SecurityEventStats;
  roleChanges: RoleChangeAudit[];
  suspiciousActivity: SuspiciousActivityAlert[];
  complianceScore: number;
}
```

### Access Control and Permissions
```typescript
interface AdminPermissions {
  canViewAllUsers: boolean;
  canEditUserRoles: boolean;
  canAssignManagers: boolean;
  canDeleteUsers: boolean;
  canViewActivityLogs: boolean;
  canGenerateReports: boolean;
  canPerformBulkOperations: boolean;
  canAccessSecurityAudit: boolean;
}

interface AdminActionValidation {
  action: AdminAction;
  targetUserId: string;
  currentUserRole: string;
  hasPermission: boolean;
  restrictions: string[];
  warningsRequired: string[];
}
```

### Performance Requirements
- **User List Loading:** User dashboard loads within 1 second for up to 10,000 users
- **Search Response:** User search results within 300ms
- **Role Changes:** Role assignment processed within 2 seconds
- **Bulk Operations:** Process up to 1,000 users within 30 seconds
- **Report Generation:** Administrative reports generated within 10 seconds

### Testing Strategy
- **Test Location:**
  - Frontend: `apps/web/src/app/features/admin/components/__tests__/`
  - Backend: `apps/api/src/handlers/admin/__tests__/`
  - Integration: `apps/api/src/services/admin/__tests__/`
- **Test Standards:**
  - User management CRUD operations with role validation
  - Bulk operations with partial failure handling
  - Manager hierarchy validation with loop detection
  - User deletion cleanup with referential integrity
- **Testing Frameworks:**
  - Frontend: Angular Testing Utilities with Jest
  - Backend: Node.js with Jest for admin handlers
  - E2E: Playwright for complete administrative workflow
- **Specific Requirements:**
  - Test admin dashboard with large user datasets (1000+ users)
  - Test role assignment with hierarchy validation
  - Test bulk operations with progress tracking
  - Test user deletion with comprehensive cleanup
  - Test manager assignment with loop detection
  - Test administrative audit trail generation
  - Test mobile responsive admin interface
  - Test admin permission validation and security
  - Test administrative reporting with various filters
  - Test concurrent admin operations with data consistency

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-12 | 1.0 | Initial detailed story creation for Epic 5 User Management | Story Manager |
| 2025-09-16 | 1.1 | Refined scope - moved ACs 5-8 to Story 5.3A for better organization | Story Manager |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*