# Story 1.5: Basic API Structure & Health Check

## Status
Approved

## Story
**As a** developer,
**I want** Lambda functions and API endpoints structured following DDD principles with a working health check,
**so that** I can validate the complete technology stack and have a foundation for business logic implementation.

## Acceptance Criteria
1. Lambda function handlers organized by domain (`travel-requests/`, `employees/`, `projects/`, `auth/`) in `apps/api/src/handlers/`
2. Shared middleware implemented for CORS, error handling, logging, and request validation
3. Domain service interfaces created in `domains/` workspace referencing business entities from brainstorming session
4. Health check endpoint (`GET /health`) implemented returning system status, database connectivity, and service versions
5. API client utilities created in `packages/shared` for TypeScript interface definitions
6. Error handling middleware returns consistent error format across all endpoints
7. Health check endpoint accessible through API Gateway and returns 200 status with proper JSON response
8. All Lambda functions deploy successfully and can be invoked through API Gateway without errors

## Tasks / Subtasks
- [ ] Create DDD-based Lambda handler structure (AC: 1)
  - [ ] Organize handlers by domain: travel-requests/, employees/, projects/, auth/
  - [ ] Create handler templates following consistent patterns
  - [ ] Set up proper TypeScript compilation for Lambda functions
  - [ ] Configure Lambda function deployment with CDK
  - [ ] Implement proper logging and tracing for each handler

- [ ] Implement shared middleware (AC: 2)
  - [ ] Create CORS middleware with proper headers for Angular frontend
  - [ ] Implement centralized error handling middleware
  - [ ] Add structured logging middleware with request tracing
  - [ ] Create request validation middleware using schema validation
  - [ ] Set up response formatting middleware for consistent API responses

- [ ] Define domain service interfaces (AC: 3)
  - [ ] Create TravelRequestService interface in domains/travel-allowance/
  - [ ] Create EmployeeService interface in domains/employee-management/
  - [ ] Create ProjectService interface in domains/project-management/
  - [ ] Define repository interfaces for data access patterns
  - [ ] Create domain entities and value objects from brainstorming session

- [ ] Implement health check endpoint (AC: 4)
  - [ ] Create GET /health endpoint with comprehensive system status
  - [ ] Test database connectivity and return connection status
  - [ ] Include service versions and build information
  - [ ] Add dependency health checks (RDS, Cognito availability)
  - [ ] Implement proper error handling for health check failures

- [ ] Create shared API client utilities (AC: 5)
  - [ ] Define TypeScript interfaces for all API request/response types
  - [ ] Create shared type definitions in packages/shared workspace
  - [ ] Generate OpenAPI schema from handler implementations
  - [ ] Create client-side API service interfaces for Angular
  - [ ] Set up proper type checking between frontend and backend

- [ ] Standardize error handling (AC: 6)
  - [ ] Define consistent error response format across all endpoints
  - [ ] Implement proper HTTP status code handling
  - [ ] Add error correlation IDs for debugging
  - [ ] Create error logging with proper severity levels
  - [ ] Handle validation errors with detailed field-level messages

- [ ] Deploy and test complete API structure (AC: 7, 8)
  - [ ] Deploy all Lambda functions through CDK
  - [ ] Test health check endpoint accessibility via API Gateway
  - [ ] Verify proper CORS headers for Angular frontend integration
  - [ ] Test error handling and response formatting
  - [ ] Validate logging and monitoring integration

## Dev Notes

### Architecture Context
From the architecture document (docs/architecture.md):
- **Backend Framework:** AWS Lambda + Fastify for minimal cold start overhead
- **API Style:** REST with OpenAPI 3.0 specification
- **Organization:** Domain-Driven Design with bounded contexts
- **Shared Types:** TypeScript interfaces in dedicated workspace package

### Domain Structure
Based on brainstorming session and architecture:
- **travel-allowance/:** Core domain with request submission and calculation logic
- **employee-management/:** Employee data and manager relationship management
- **project-management/:** Project and subproject data with geographic locations
- **Shared-kernel/:** Cross-domain shared concepts and utilities

### API Response Format
Consistent response format across all endpoints:
```typescript
// Success Response
{
  success: true,
  data: any,
  timestamp: string,
  requestId: string
}

// Error Response  
{
  success: false,
  error: {
    code: string,
    message: string,
    details?: Record<string, any>,
    timestamp: string,
    requestId: string
  }
}
```

### Health Check Response Format
```typescript
{
  status: "healthy" | "degraded" | "unhealthy",
  timestamp: string,
  version: string,
  services: {
    database: { status: string, responseTime: number },
    cognito: { status: string, responseTime: number },
    ses: { status: string, responseTime: number }
  }
}
```

### Performance Requirements
- **Response Time:** Health check and all endpoints must support <500ms (NFR1)
- **CORS Configuration:** Proper CORS headers for Angular frontend (NFR5)
- **Logging:** Structured logging for debugging and monitoring (NFR12)
- **Error Handling:** Client-side and server-side validation (NFR5)

### Testing Requirements
- **Test Location:** apps/api/src/__tests__/ with domain-specific subdirectories
- **Test Standards:** Unit tests for handlers, integration tests for API Gateway
- **Testing Frameworks:** Vitest with Supertest for API endpoint testing
- **Specific Requirements:**
  - Test health check endpoint returns proper JSON format
  - Test CORS headers are correctly configured
  - Test error handling middleware with various error scenarios
  - Test Lambda deployment and API Gateway integration
  - Integration test complete request/response cycle

### Testing
- **Test Location:** apps/api/src/__tests__/handlers/ and apps/api/src/__tests__/middleware/
- **Test Standards:** Unit tests for individual handlers, integration tests for API flows
- **Testing Frameworks:** 
  - Vitest with Supertest for API endpoint testing
  - AWS Lambda testing utilities for handler testing
- **Specific Requirements:**
  - Test complete API request/response cycle through API Gateway
  - Test middleware execution order and error handling
  - Test domain service interface implementations
  - Test shared type definitions between frontend and backend
  - Load test health check endpoint for performance validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 1 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*