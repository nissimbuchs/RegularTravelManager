# Story 1.3: Database Schema & Initial Data

## Status
Aproved

## Story
**As a** developer,
**I want** PostgreSQL database schema created with PostGIS geographic functions,
**so that** I can store employee, project, and travel request data with proper relationships and constraints.

## Acceptance Criteria
1. Database tables created for employees, projects, subprojects, and travel_requests with proper foreign key relationships
2. PostGIS extension enabled with geometric functions for distance calculations working correctly
3. Database indexes created on frequently queried columns (employee_id, manager_id, status, location coordinates)
4. Business rule constraints implemented (valid status values, positive amounts, coordinate validation)
5. Sample seed data inserted for at least 2 employees, 1 manager, 2 projects with subprojects and geographic coordinates
6. Database migration scripts created for schema versioning and deployment automation
7. Connection pooling configured for Lambda function database access

## Tasks / Subtasks
- [ ] Create core database schema (AC: 1)
  - [ ] Create employees table with home address and coordinates
  - [ ] Create projects table with project metadata
  - [ ] Create subprojects table with location data and cost rates
  - [ ] Create travel_requests table (main aggregate) with all required fields
  - [ ] Create employee_address_history table for audit trail (required by Story 2.1)
  - [ ] Create request_status_history table for request audit trail
  - [ ] Define proper foreign key relationships between tables

- [ ] Enable PostGIS extension (AC: 2)
  - [ ] Install PostGIS extension in PostgreSQL database
  - [ ] Create PostGIS geometric data types for location storage
  - [ ] Implement distance calculation function using ST_Distance
  - [ ] Test geographic calculations with sample coordinate data
  - [ ] Validate distance calculation accuracy for Swiss locations

- [ ] Create database indexes for performance (AC: 3)
  - [ ] Index employee_id columns for fast employee lookups
  - [ ] Index manager_id columns for manager queries
  - [ ] Index status column for request filtering
  - [ ] Create spatial indexes on location coordinates
  - [ ] Index created_at and updated_at timestamps

- [ ] Implement business rule constraints (AC: 4)
  - [ ] Add CHECK constraints for valid request status values
  - [ ] Add CHECK constraints for positive allowance amounts
  - [ ] Add CHECK constraints for valid coordinate ranges
  - [ ] Add CHECK constraints for valid days_per_week (1-7)
  - [ ] Add NOT NULL constraints for required fields

- [ ] Create sample seed data (AC: 5)
  - [ ] Insert 2 sample employees with Swiss home addresses
  - [ ] Insert 1 sample manager with proper employee relationship
  - [ ] Insert 2 sample projects with Swiss business context
  - [ ] Insert subprojects with realistic Swiss locations and coordinates
  - [ ] Create sample travel requests to test complete workflow

- [ ] Set up database migration system (AC: 6)
  - [ ] Create database migration scripts for schema versioning
  - [ ] Implement rollback scripts for each migration
  - [ ] Set up migration execution system for deployment automation
  - [ ] Create database setup scripts for different environments
  - [ ] Document migration process and best practices

- [ ] Configure connection pooling (AC: 7)
  - [ ] Set up RDS Proxy for Lambda connection pooling
  - [ ] Configure connection pool sizing and timeout settings
  - [ ] Test connection pool behavior under concurrent Lambda executions
  - [ ] Implement proper connection error handling
  - [ ] Monitor connection pool metrics and performance

## Dev Notes

### Architecture Context
From the architecture document (docs/architecture.md):
- **Database:** Amazon RDS PostgreSQL 15+ with PostGIS extension
- **Geographic Functions:** PostGIS ST_Distance for straight-line distance calculations
- **Region:** EU-Central-1 (Frankfurt) for Swiss data residency
- **Connection Pattern:** RDS Proxy for Lambda connection pooling

### Data Models
From the architecture document, core domain models include:
- **TravelRequest:** Main aggregate with employee, manager, project references
- **Employee:** User data with home address coordinates  
- **Project/SubProject:** Project data with location coordinates
- **Address/Location:** Value objects for geographic data

### Database Schema (from architecture.md)
```sql
-- Enable PostGIS extension for geographic functions
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Core business tables:
-- employees (with home_location GEOMETRY(POINT, 4326))
-- employee_address_history (audit trail for address changes)
-- projects and subprojects (with location coordinates)  
-- travel_requests (main aggregate with calculated fields)
-- request_status_history (audit trail for status changes)
```

### Swiss Business Requirements
- **Currency:** All amounts in Swiss Francs (CHF) with proper decimal precision (FR15)
- **Distance Calculation:** Straight-line distance methodology using PostGIS (FR2)
- **Cost Rates:** Project-specific cost-per-kilometer rates in CHF (FR3)
- **Geographic Precision:** Distance calculations to 3 decimal places (NFR8)

### Performance Requirements
- **Connection Pooling:** Required for Lambda concurrent executions (NFR2)
- **Response Time:** Database queries must support <500ms API response (NFR1)
- **Concurrency:** Support up to 100 concurrent users (NFR9)
- **Schema Constraints:** Business rules enforced at database level (NFR13)

### Testing
- **Test Location:** Database tests in apps/api/src/__tests__/database/
- **Test Standards:** Integration tests with real PostgreSQL instance
- **Testing Frameworks:** Vitest with database testing utilities
- **Specific Requirements:**
  - Test PostGIS distance calculations with Swiss coordinates
  - Test all database constraints and foreign key relationships
  - Test connection pooling under concurrent access
  - Test migration scripts forward and backward compatibility

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 1 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*