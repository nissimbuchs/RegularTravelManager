# Story 7.2: dynamic-master-data-translation-service

## Status
Accepted

## Story
**As a** Swiss business user,
**I want** project names, subproject names, and descriptions to appear in my selected language,
**so that** all content in the application is consistently localized without mixing languages.

## Acceptance Criteria
1. **Translation Proxy Lambda**: Implement backend Lambda function integrating with AWS Translate service
2. **Master Data Translation Service**: Create frontend service for translating user-generated content with intelligent caching
3. **HTTP Response Interceptor**: Automatic translation of configured API response fields (project names, descriptions)
4. **Database Translation Cache**: PostgreSQL table for caching translations (24-hour TTL) to optimize performance and costs
5. **Configuration-Driven Mapping**: Configurable field mapping for automatic translation per API endpoint
6. **Error Handling**: Graceful fallback to original text if translation fails
7. **Performance Optimization**: Multi-level caching (backend + frontend) and batch translation support

## Tasks / Subtasks

- [ ] Task 1: Create Translation Proxy Lambda Function (AC: 1)
  - [ ] Create handler `apps/api/src/handlers/translation/translate-master-data.ts`
  - [ ] Implement AWS Translate client integration with TranslateTextCommand
  - [ ] Add PostgreSQL translation cache lookup and storage functions
  - [ ] Implement profanity filtering with 'MASK' setting for Swiss business
  - [ ] Add comprehensive error handling with original text fallback

- [ ] Task 2: Implement Database Translation Cache (AC: 4)
  - [ ] Create migration script for `master_data_translations` table
  - [ ] Add performance indexes (lookup + expiry)
  - [ ] Implement automatic cleanup function for expired translations
  - [ ] Add unique constraint on (original_text, target_language, context)

- [ ] Task 3: Create Frontend Master Data Translation Service (AC: 2)
  - [ ] Create `MasterDataTranslationService` in `apps/web/src/app/core/services/`
  - [ ] Implement memory cache with 30-minute TTL
  - [ ] Add batch translation support for performance optimization
  - [ ] Implement cache management (clear, statistics)

- [ ] Task 4: Implement HTTP Response Interceptor (AC: 3)
  - [ ] Create `MasterDataTranslationInterceptor` in `apps/web/src/app/core/interceptors/`
  - [ ] Configure TRANSLATION_CONFIG mapping for API endpoints
  - [ ] Implement automatic field translation based on URL matching
  - [ ] Add recursive object traversal for nested field translation

- [ ] Task 5: Add Configuration-Driven Mapping (AC: 5)
  - [ ] Configure field mapping for `/api/projects` (name, description)
  - [ ] Configure field mapping for `/api/subprojects` (name, description)
  - [ ] Configure field mapping for `/api/travel-requests` (projectName, subprojectName)
  - [ ] Configure field mapping for `/api/employees/dashboard` (projectName, subprojectName)

- [ ] Task 6: Implement Error Handling and Fallbacks (AC: 6)
  - [ ] Add graceful fallback to original text in Lambda function
  - [ ] Implement frontend error handling in translation service
  - [ ] Add fallback handling in HTTP interceptor
  - [ ] Include fallback indicators in translation responses

- [ ] Task 7: Performance Optimization Implementation (AC: 7)
  - [ ] Implement multi-level caching (PostgreSQL + memory)
  - [ ] Add batch translation support in frontend service
  - [ ] Optimize Lambda function with appropriate memory allocation
  - [ ] Add cache hit rate monitoring and logging

- [ ] Task 8: Infrastructure Configuration
  - [ ] Add Lambda function to LambdaStack with AWS Translate permissions
  - [ ] Configure API Gateway endpoint `/api/translate-master-data`
  - [ ] Set up IAM permissions for AWS Translate service
  - [ ] Configure Lambda function memory (256-512MB) and timeout (30s)

- [ ] Task 9: Unit and Integration Testing
  - [ ] Write unit tests for Lambda translation handler
  - [ ] Write unit tests for MasterDataTranslationService
  - [ ] Write unit tests for HTTP Response Interceptor
  - [ ] Write integration tests for end-to-end translation flow

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [x] **New Components/Pages** - List components that need creation: None (services only)
- [x] **State Management** - RxJS service updates needed (BehaviorSubjects, observables):
  - MasterDataTranslationService with caching and batch translation observables
- [ ] **Routing** - New routes or route guards required: None
- [x] **API Integration** - New HTTP service methods needed:
  - MasterDataTranslationService with `/api/translate-master-data` integration

### Backend Changes
- [x] **New API Endpoints** - List all new REST endpoints:
  - [x] `POST /api/translate-master-data` - Translation proxy endpoint with request validation
- [x] **Lambda Functions** - New Lambda handlers required:
  - [x] Handler file: `apps/api/src/handlers/translation/translate-master-data.ts`
- [x] **Database Changes** - Schema modifications needed:
  - [x] Migration script: `migrations/xxx-add-master-data-translations-table.sql`
  - [x] New tables: `master_data_translations` with indexes and cleanup function
- [x] **Authentication** - Auth/authorization changes:
  - [x] Cognito JWT authentication required for translation endpoint

### Infrastructure Changes (AWS CDK)
- [x] **API Gateway** - New routes/methods/cors:
  - File: `infrastructure/src/api-gateway-stack.ts` - Add POST /api/translate-master-data
- [x] **Lambda Configuration** - Function definitions:
  - File: `infrastructure/src/lambda-stack.ts` - Add translateMasterDataFunction
- [x] **Database** - RDS changes or migrations:
  - Database migration for master_data_translations table
- [x] **Environment Variables** - New config needed:
  - Production: AWS_REGION for AWS Translate client
- [x] **IAM Permissions** - New service permissions:
  - AWS Translate permissions: translate:TranslateText, translate:ListLanguages
- [x] **Other AWS Services** - AWS Translate service integration

### Development Environment
- [ ] **Docker Services** - New services in docker-compose.yml: None
- [ ] **LocalStack** - New mocked AWS services: AWS Translate (Pro feature - may need mocking)
- [x] **Sample Data** - Database seed updates needed:
  - Add sample translations for testing purposes
- [ ] **Environment Setup** - New setup steps required: None

## Dev Notes

### Technical Design Notes

**Full-Stack Translation Architecture Implementation**:
This story implements Layer 2 of the dual-layer translation system - AWS Translate-powered dynamic master data translation. The architecture uses a hybrid approach combining backend translation proxy with frontend HTTP response interceptor for transparent, automatic translation.

**Core Implementation Architecture** [Source: docs/i18n.md#5.2]:
```typescript
1. Translation Proxy API (Backend)
   ├── AWS Lambda function with AWS Translate integration
   ├── PostgreSQL translation cache (24h TTL)
   └── API Gateway endpoint /api/translate-master-data

2. HTTP Response Interceptor (Frontend)
   ├── Automatic translation of configured API response fields
   ├── Configuration-driven field mapping
   └── Intelligent caching and error handling

3. Master Data Translation Service (Frontend)
   ├── Service layer with batch translation support
   ├── Memory cache (30min TTL)
   └── Fallback strategies for translation failures
```

**Backend Lambda Implementation** [Source: docs/i18n.md#5.3, docs/architecture/06-backend-architecture.md]:
- **Handler Location**: `apps/api/src/handlers/translation/translate-master-data.ts`
- **AWS Translate Integration**: Uses TranslateTextCommand with 'auto' source language detection
- **Business Appropriate**: Profanity masking with Settings: { Profanity: 'MASK' }
- **Swiss Data Residency**: Deployed in eu-central-1 region
- **Cache Strategy**: PostgreSQL lookup before AWS API calls to minimize costs

**Translation Cache Implementation** [Source: docs/architecture/03-data-architecture.md]:
```sql
CREATE TABLE master_data_translations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  original_text TEXT NOT NULL,
  translated_text TEXT NOT NULL,
  source_language VARCHAR(2) DEFAULT 'auto',
  target_language VARCHAR(2) NOT NULL CHECK (target_language IN ('de', 'fr', 'it', 'en')),
  context VARCHAR(50) NOT NULL,
  confidence_score DECIMAL(3,2) CHECK (confidence_score >= 0 AND confidence_score <= 1),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '24 hours'),
  UNIQUE(original_text, target_language, context)
);
```

**Frontend Service Architecture** [Source: docs/i18n.md#5.4]:
- **MasterDataTranslationService**: Memory cache with 30min TTL, batch translation support
- **MasterDataTranslationInterceptor**: Automatic translation based on URL endpoint matching
- **Configuration Mapping**: TRANSLATION_CONFIG defines translatable fields per API endpoint

**API Integration Specifications** [Source: docs/architecture/04-api-design.md]:
```typescript
// Request Format
interface TranslationRequest {
  text: string;
  targetLanguage: 'de' | 'fr' | 'it' | 'en';
  context?: 'project' | 'subproject' | 'description';
}

// Response Format
interface TranslationResponse {
  translatedText: string;
  originalText: string;
  confidence: number;
  language: string;
  cached: boolean;
  fallback?: boolean;
}
```

**HTTP Response Interceptor Configuration** [Source: docs/i18n.md#5.4]:
```typescript
const TRANSLATION_CONFIG: Record<string, string[]> = {
  '/api/projects': ['name', 'description'],
  '/api/subprojects': ['name', 'description'],
  '/api/travel-requests': ['projectName', 'subprojectName'],
  '/api/employees/dashboard': ['projectName', 'subprojectName']
};
```

**Performance Optimization Strategy** [Source: docs/architecture/06-backend-architecture.md]:
- **Multi-Level Caching**: PostgreSQL (24h) + Frontend memory (30min) + ShareReplay operators
- **Lambda Optimization**: 256-512MB memory, 30s timeout, provisioned concurrency consideration
- **Cost Optimization**: Cache reduces AWS Translate API calls by ~80%
- **Batch Processing**: Frontend batch translation for improved performance

**Error Handling and Resilience** [Source: docs/i18n.md#5.3]:
- **Graceful Degradation**: Original text returned if translation fails
- **Fallback Indicators**: Response includes fallback flag for monitoring
- **Silent Error Handling**: Translation failures don't break user experience
- **Comprehensive Logging**: Error logging for translation service monitoring

### Testing Standards

**Testing Framework and Patterns** [Source: docs/architecture/07-development-standards.md]:
- **Backend Testing**: Jest + Supertest for Lambda function testing
- **Frontend Testing**: Jest + Angular Testing Utilities
- **Integration Testing**: End-to-end translation flow validation

**Testing Requirements for Translation System**:
- **Lambda Handler Testing**: AWS Translate client mocking, PostgreSQL cache testing, error scenarios
- **Frontend Service Testing**: HTTP client mocking, cache behavior, batch translation
- **HTTP Interceptor Testing**: Response transformation, field mapping, error handling
- **Database Testing**: Migration validation, cache cleanup, index performance

**Testing Patterns**:
- **AWS Service Mocking**: Mock AWS Translate client for unit tests
- **Database Testing**: Test PostgreSQL functions and indexes
- **HTTP Testing**: Use HttpClientTestingModule for frontend service testing
- **Integration Testing**: Full translation flow from API request to UI display

## Definition of Done Checklist

### Development Complete
- [ ] All acceptance criteria implemented
- [ ] Unit tests written and passing
- [ ] Integration tests cover new functionality
- [ ] Code follows project conventions
- [ ] TypeScript types properly defined in packages/shared

### Infrastructure Complete ⚠️ CRITICAL
- [ ] All infrastructure changes implemented in CDK
- [ ] CDK diff reviewed and approved (`npm run infrastructure:plan`)
- [ ] Environment variables configured (dev + prod)
- [ ] IAM permissions validated (AWS Translate access)
- [ ] API Gateway routes deployed and tested
- [ ] Lambda functions deployed and tested
- [ ] Database migrations applied successfully
- [ ] Infrastructure validation passes (`npm run infrastructure:validate`)

### Review Ready
- [ ] PR created with infrastructure checklist completed
- [ ] Code review completed
- [ ] Infrastructure review completed
- [ ] Documentation updated
- [ ] CLAUDE.md updated if commands changed

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-25 | 1.0 | Initial story creation with complete full-stack technical context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- Populated by development agent -->

### Debug Log References
<!-- Populated by development agent -->

### Completion Notes List
<!-- Populated by development agent -->

### File List
<!-- Populated by development agent -->

## QA Results
<!-- Results from QA Agent review -->