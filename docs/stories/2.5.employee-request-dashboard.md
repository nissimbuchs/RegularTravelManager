# Story 2.5: Employee Request Dashboard

## Status
Approved

## Story
**As an** employee,
**I want** to view all my travel requests with status and calculated amounts,
**so that** I can track request progress and see my approved allowances.

## Acceptance Criteria
1. Dashboard displays all employee requests in a table with columns for project, subproject, status, submitted date, and allowance amounts
2. Status indicators use color coding (yellow for pending, green for approved, red for rejected) with clear visual hierarchy
3. Request details expandable to show full justification, manager assigned, distance calculation, and status history
4. Filter capabilities allow viewing requests by status (all, pending, approved, rejected) and date ranges
5. Approved requests clearly display daily allowance amount and weekly total with CHF formatting
6. Pagination or infinite scroll handles large numbers of requests efficiently
7. Dashboard updates automatically when request status changes without requiring page refresh

## Tasks / Subtasks
- [ ] Create employee dashboard Angular component (AC: 1)
  - [ ] Design dashboard layout with Angular Material table
  - [ ] Implement data service for fetching employee requests
  - [ ] Create responsive table with proper column organization
  - [ ] Add sorting capabilities for date, status, and amount columns
  - [ ] Implement loading states and error handling

- [ ] Implement status visual indicators (AC: 2)
  - [ ] Create color-coded status badges (yellow=pending, green=approved, red=rejected)
  - [ ] Add status icons for enhanced visual recognition
  - [ ] Implement consistent color scheme across the application
  - [ ] Add accessibility support for color-blind users
  - [ ] Create status legend for user guidance

- [ ] Build expandable request details (AC: 3)
  - [ ] Create expandable row component for detailed information
  - [ ] Display full justification text with proper formatting
  - [ ] Show assigned manager information and contact details
  - [ ] Display distance calculation breakdown with transparency
  - [ ] Add request status history timeline with timestamps

- [ ] Add filtering and search capabilities (AC: 4)
  - [ ] Create status filter dropdown (all, pending, approved, rejected)
  - [ ] Implement date range picker for filtering by submission date
  - [ ] Add search functionality for project names and descriptions
  - [ ] Create filter combination logic with proper query handling
  - [ ] Add filter state persistence in URL parameters

- [ ] Format allowance amounts properly (AC: 5)
  - [ ] Display daily allowance with CHF currency formatting
  - [ ] Calculate and show weekly totals based on days per week
  - [ ] Add total monthly estimates for approved requests
  - [ ] Implement proper Swiss CHF decimal formatting (2 places)
  - [ ] Create allowance summary cards for quick overview

- [ ] Implement efficient data handling (AC: 6)
  - [ ] Add pagination with configurable page sizes (10, 25, 50)
  - [ ] Implement virtual scrolling for very large datasets
  - [ ] Create lazy loading for request details and attachments
  - [ ] Add infinite scroll option for mobile devices
  - [ ] Optimize API calls and data caching strategies

- [ ] Add real-time dashboard updates (AC: 7)
  - [ ] Implement WebSocket connection for real-time updates
  - [ ] Create notification system for status changes
  - [ ] Add automatic refresh polling as fallback
  - [ ] Handle connection failures gracefully
  - [ ] Update dashboard data without losing user context

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [ ] **New Components/Pages** - Employee dashboard component:
  - [ ] Dashboard layout with Angular Material table
  - [ ] Request details expandable rows
  - [ ] Status indicators and color-coded badges
  - [ ] Filter and search components
- [ ] **State Management** - RxJS service updates needed (BehaviorSubjects, observables):
  - [ ] Request list management state
  - [ ] Filter and pagination state
  - [ ] Real-time update state management
- [ ] **Routing** - Dashboard routes configured:
  - [ ] Employee dashboard route with authentication
  - [ ] Deep linking for filtered views
- [ ] **API Integration** - HTTP services for dashboard data:
  - [ ] Employee requests service with pagination
  - [ ] Real-time updates service (WebSocket or polling)
  - [ ] Request filtering and search service

### Backend Changes
- [ ] **New API Endpoints** - REST endpoints for dashboard:
  - [ ] `GET /employees/{cognitoUserId}/requests` - Get employee requests with pagination
  - [ ] `GET /employees/{cognitoUserId}/requests/{id}` - Get request details
  - [ ] `GET /employees/{cognitoUserId}/requests/summary` - Get request statistics
  - [ ] `GET /employees/{cognitoUserId}/requests/status/{status}` - Filter by status
- [ ] **Lambda Functions** - Lambda handlers for dashboard:
  - [ ] Handler file: `apps/api/src/handlers/employees/dashboard.ts`
  - [ ] Real-time notification service integration
  - [ ] Request aggregation and summary calculations
- [ ] **Database Changes** - Schema enhancements:
  - [ ] Request history views for efficient querying
  - [ ] Indexes on employee_id, status, submitted_at for dashboard queries
  - [ ] Request summary materialized views for performance
- [ ] **Authentication** - Auth/authorization:
  - [ ] Employee access control for own requests only
  - [ ] JWT token validation for dashboard endpoints

### Infrastructure Changes (AWS CDK)
- [ ] **API Gateway** - Dashboard routes:
  - File: `infrastructure/lib/api-gateway-stack.ts`
  - Routes: /employees/*/requests/*, /employees/*/dashboard/*
- [ ] **Lambda Configuration** - Dashboard functions:
  - File: `infrastructure/lib/lambda-stack.ts`
  - Functions: getEmployeeRequestsFunction, getRequestSummaryFunction
- [ ] **Database** - RDS dashboard optimizations:
  - Request views and indexes for performance
  - Dashboard-specific query optimizations
- [ ] **Environment Variables** - Dashboard configuration:
  - Development: `docker-compose.yml` - Dashboard service settings
  - Production: Lambda environment variables for dashboard
- [ ] **IAM Permissions** - Dashboard permissions:
  - rds-db:connect for database access
  - logs:* for CloudWatch logging
- [ ] **Other AWS Services** - Real-time services:
  - WebSocket API Gateway for real-time updates (optional)
  - SNS/SQS for notification delivery (if implemented)

### Development Environment
- [ ] **Docker Services** - Dashboard development environment
- [ ] **LocalStack** - Dashboard API mocking
- [ ] **Sample Data** - Employee requests with various statuses for testing
- [ ] **Environment Setup** - Dashboard development environment ready

## Dev Notes

### Architecture Context
From the architecture document:
- **Frontend:** Angular 17+ with Angular Material table and card components
- **State Management:** RxJS services for dashboard state and real-time updates
- **Real-time Updates:** WebSocket integration or polling for status changes
- **Data Handling:** Efficient pagination and virtual scrolling

### UX Requirements
From UX specifications:
- **Dashboard-centric Navigation:** Dashboard as primary navigation hub
- **Status-driven Visual Hierarchy:** Color-coded status indicators
- **Progressive Disclosure:** Expandable details for complex information
- **Mobile Support:** Responsive design with touch-friendly interactions

### Business Requirements  
From PRD requirements:
- **Employee Dashboard:** Personal request overview with status tracking (FR9)
- **Status Transparency:** Clear visibility into request lifecycle
- **Allowance Display:** Daily and weekly amounts in CHF (FR15)
- **Request History:** Complete audit trail visibility (FR12)

### Dashboard Data Model
```typescript
interface EmployeeDashboard {
  requests: TravelRequest[];
  totalRequests: number;
  pendingCount: number;
  approvedCount: number;
  rejectedCount: number;
  totalApprovedAllowance: number; // CHF monthly
}

interface TravelRequestSummary {
  id: string;
  projectName: string;
  subProjectName: string;
  status: RequestStatus;
  submittedDate: Date;
  processedDate?: Date;
  dailyAllowance: number;
  weeklyAllowance: number;
  daysPerWeek: number;
  managerName: string;
}
```

### Status Color Scheme
- **Pending:** `#ff9800` (Orange/Yellow) - Warning color
- **Approved:** `#4caf50` (Green) - Success color  
- **Rejected:** `#f44336` (Red) - Error color
- **Withdrawn:** `#9e9e9e` (Gray) - Disabled color

### Real-time Update Strategy
1. WebSocket connection for immediate status updates
2. Polling fallback every 30 seconds for connection failures
3. User notification system for status changes
4. Optimistic UI updates with rollback on failure

### Testing
- **Test Location:** 
  - Frontend: apps/web/src/app/features/employee/components/__tests__/
  - Integration: apps/web/src/app/__tests__/dashboard/
- **Test Standards:** 
  - Angular component testing with mock data
  - Real-time update testing with WebSocket mocks
- **Testing Frameworks:** 
  - Frontend: Angular Testing Utilities with Jest
  - E2E: Playwright for complete dashboard interaction
- **Specific Requirements:**
  - Test table sorting and filtering functionality
  - Test expandable row details and status history
  - Test real-time updates and notification handling
  - Test pagination and virtual scrolling performance
  - Test mobile responsive behavior and touch interactions
  - Test accessibility features and screen reader support

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 2 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*