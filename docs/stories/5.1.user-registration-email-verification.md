# Story 5.1: User Registration & Email Verification

## Status
Approved

## Story
**As a** new user,
**I want** to register for an account with email verification and initial profile setup,
**so that** I can access the RegularTravelManager system and begin submitting travel requests.

## Acceptance Criteria
1. Registration form accepts email, password, first name, last name, and home address with proper client-side and server-side validation
2. Password requirements enforce minimum 8 characters with uppercase, lowercase, number, and special character matching existing Cognito policies
3. Email verification process sends confirmation email with secure token and requires click-through verification before account activation
4. Address geocoding automatically converts home address to coordinates using existing PostGIS infrastructure for distance calculations
5. New user accounts default to 'employee' role with ability for admin to modify role assignment through existing role management system
6. Registration process integrates seamlessly with existing Cognito User Pool (`eu-central-1_LFA9Rhk2y`) without affecting current users or authentication flows
7. Form validation provides clear, user-friendly error messages for invalid inputs, duplicate email addresses, and geocoding failures
8. Successful registration creates both Cognito user record and corresponding employee database record with proper foreign key relationships

## Tasks / Subtasks
- [ ] Create user registration API endpoints (AC: 1, 6, 8)
  - [ ] Build `POST /api/auth/register` Lambda function with comprehensive validation
  - [ ] Implement Cognito user creation with proper group assignment
  - [ ] Create employee database record with foreign key to Cognito user
  - [ ] Add proper error handling for duplicate emails and Cognito failures
  - [ ] Implement transaction rollback for partial registration failures
  - [ ] Add comprehensive input sanitization and validation middleware

- [ ] Implement email verification system (AC: 3)
  - [ ] Create secure verification token generation with expiration
  - [ ] Build `POST /api/auth/verify-email` endpoint for token validation
  - [ ] Design professional email templates using existing SES configuration
  - [ ] Implement token expiration handling (24-hour validity)
  - [ ] Add resend verification email capability
  - [ ] Create verification status tracking in database

- [ ] Build address geocoding integration (AC: 4)
  - [ ] Integrate with existing PostGIS geocoding functions
  - [ ] Add address validation with Swiss postal code format
  - [ ] Implement geocoding fallback for invalid addresses
  - [ ] Add coordinate validation and boundary checking for Switzerland
  - [ ] Create geocoding error handling with user feedback
  - [ ] Store geocoding metadata for audit purposes

- [ ] Create registration frontend components (AC: 1, 2, 7)
  - [ ] Build `UserRegistrationComponent` with Angular Material design
  - [ ] Implement real-time form validation with error messaging
  - [ ] Create password strength indicator matching Cognito requirements
  - [ ] Add address autocomplete integration for Swiss addresses
  - [ ] Design mobile-responsive registration form
  - [ ] Implement form state management with draft saving

- [ ] Ensure backward compatibility (AC: 5, 6)
  - [ ] Validate existing authentication flows remain unchanged
  - [ ] Test current user sessions continue working during deployment
  - [ ] Ensure existing test users in Cognito remain functional
  - [ ] Validate role-based routing continues working
  - [ ] Test API endpoints maintain existing response formats
  - [ ] Create migration path for existing employee records

- [ ] Add comprehensive error handling and security (AC: 7)
  - [ ] Implement rate limiting for registration attempts
  - [ ] Add CAPTCHA integration to prevent bot registrations
  - [ ] Create comprehensive audit logging for registration events
  - [ ] Implement account lockout for failed verification attempts
  - [ ] Add monitoring alerts for registration failures
  - [ ] Create administrative notification for new registrations

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [ ] **New Components/Pages** - User registration and email verification flows
- [ ] **State Management** - RxJS service updates for registration state management:
  - [ ] `AuthService` extension with registration methods
  - [ ] Registration state management with BehaviorSubjects
  - [ ] Form validation state management
- [ ] **Routing** - Public registration routes with proper navigation:
  - [ ] `/register` - Main registration form
  - [ ] `/verify-email` - Email verification handler
  - [ ] `/registration-success` - Post-registration confirmation
- [ ] **API Integration** - HTTP services for registration workflow:
  - [ ] Registration form submission service
  - [ ] Email verification service
  - [ ] Address geocoding service integration

### Backend Changes
- [ ] **New API Endpoints** - Registration and verification REST endpoints:
  - [ ] `POST /api/auth/register` - User registration with validation
  - [ ] `POST /api/auth/verify-email` - Email verification with token
  - [ ] `POST /api/auth/resend-verification` - Resend verification email
  - [ ] `GET /api/auth/registration-status` - Check registration completion
- [ ] **Lambda Functions** - New Lambda handlers for registration workflow:
  - [ ] Handler file: `apps/api/src/handlers/auth/register-user.ts`
  - [ ] Handler file: `apps/api/src/handlers/auth/verify-email.ts`
  - [ ] Handler file: `apps/api/src/handlers/auth/resend-verification.ts`
  - [ ] Handler file: `apps/api/src/handlers/auth/registration-status.ts`
- [ ] **Database Changes** - Schema modifications for registration tracking:
  - [ ] Migration script: `migrations/020-create-user-registrations-table.sql`
  - [ ] Migration script: `migrations/021-add-employee-profile-fields.sql`
  - [ ] New table: `user_registrations` for verification token tracking
  - [ ] Employee table enhancements for registration metadata
- [ ] **Authentication** - Registration integration with existing Cognito setup:
  - [ ] Registration flow integration with existing JWT validation
  - [ ] Role assignment using existing user groups
  - [ ] Email verification status tracking

### Infrastructure Changes (AWS CDK)
- [ ] **API Gateway** - New routes for registration endpoints:
  - File: `infrastructure/lib/api-gateway-stack.ts`
  - Routes: `/auth/register`, `/auth/verify-email`, `/auth/resend-verification`
- [ ] **Lambda Configuration** - Function definitions for registration:
  - File: `infrastructure/lib/lambda-stack.ts`
  - Functions: `registerUserFunction`, `verifyEmailFunction`, `resendVerificationFunction`
- [ ] **Database** - RDS schema updates:
  - User registration tracking table
  - Employee profile enhancements
  - Proper foreign key constraints
- [ ] **Environment Variables** - Registration configuration:
  - Development: `docker-compose.yml` - Email and geocoding config
  - Production: `infrastructure/lib/config/environment-config.ts` - Verification settings
- [ ] **IAM Permissions** - Service permissions for registration:
  - Cognito user management permissions
  - SES email sending permissions  
  - PostGIS geocoding access
- [ ] **Other AWS Services**:
  - AWS SES - Registration and verification email templates
  - AWS Cognito - User pool configuration updates
  - CloudWatch - Registration monitoring and alerting

### Development Environment
- [ ] **Docker Services** - No changes required to existing services
- [ ] **LocalStack** - Cognito and SES mocking for registration testing
- [ ] **Sample Data** - Registration test scenarios and verification flows
- [ ] **Environment Setup** - Registration workflow testing configuration

## Dev Notes

### Architecture Context
From the architecture document:
- **Brownfield Enhancement:** Extends existing Cognito User Pool (`eu-central-1_LFA9Rhk2y`) with registration capabilities
- **Backward Compatibility:** All existing authentication flows must remain functional
- **Database Integration:** Creates employee records linked to Cognito users via UUID
- **Email Service:** Leverages existing AWS SES configuration for verification emails

### Existing System Integration
From brainstorming session and current implementation:
- **Authentication Flow:** Registration must integrate with existing JWT token validation
- **Role Management:** New users get 'employee' role, admin can modify via existing role system
- **Address Management:** Uses existing PostGIS functions for coordinate calculation
- **Email Templates:** Follows existing SES template structure and Swiss business styling

### Security Requirements
From PRD non-functional requirements:
- **Password Policy:** Minimum 8 characters with complexity requirements (NFR7)
- **HTTPS/TLS:** All registration data transmitted securely (NFR6)
- **Input Validation:** Both client-side and server-side validation (NFR5)
- **Rate Limiting:** Prevent registration abuse with appropriate throttling (NFR14)

### Registration Data Model
```typescript
interface RegisterRequest {
  email: string;
  password: string;
  firstName: string;
  lastName: string;
  homeAddress: {
    street: string;
    city: string;
    postalCode: string;
    country: string; // Default: 'Switzerland'
  };
  acceptTerms: boolean;
  acceptPrivacy: boolean;
}

interface RegisterResponse {
  userId: string;
  email: string;
  verificationRequired: boolean;
  message: string;
}

interface VerificationToken {
  id: string;
  email: string;
  token: string;
  expiresAt: Date;
  verifiedAt?: Date;
  createdAt: Date;
}

interface EmployeeProfile {
  id: string; // UUID
  cognitoUserId: string; // Link to Cognito User Pool
  email: string;
  firstName: string;
  lastName: string;
  homeAddress: string;
  homeCoordinates: Point; // PostGIS point type
  role: 'employee' | 'manager' | 'admin';
  isActive: boolean;
  registeredAt: Date;
  emailVerifiedAt?: Date;
  profileCompletedAt?: Date;
}
```

### Email Verification Flow
```typescript
interface VerificationEmailTemplate {
  subject: 'Welcome to RegularTravelManager - Please Verify Your Email';
  templateData: {
    firstName: string;
    verificationUrl: string;
    expirationHours: number;
    supportEmail: string;
  };
}

interface VerificationProcess {
  step1: 'User submits registration form';
  step2: 'System creates Cognito user (disabled state)';
  step3: 'System creates employee record (inactive)';
  step4: 'System sends verification email with token';
  step5: 'User clicks verification link';
  step6: 'System validates token and enables Cognito user';
  step7: 'System activates employee record';
  step8: 'User can now log in and access system';
}
```

### Address Geocoding Integration
```sql
-- Leverage existing PostGIS functions for address geocoding
-- Note: Database uses snake_case for column names per SQL conventions
CREATE OR REPLACE FUNCTION geocode_address(
  street_address TEXT,
  city TEXT,
  postal_code TEXT,
  country TEXT DEFAULT 'Switzerland'
) RETURNS POINT AS $$
DECLARE
  coordinates POINT;
BEGIN
  -- Use existing geocoding service or PostGIS functions
  -- Return point with longitude, latitude coordinates
  -- Validate coordinates are within Swiss boundaries
  RETURN coordinates;
END;
$$ LANGUAGE plpgsql;
```

### Cognito Integration
```typescript
interface CognitoUserCreation {
  UserPool: 'eu-central-1_LFA9Rhk2y'; // Existing User Pool
  Username: string; // User's email address
  TemporaryPassword: string; // System-generated, user must change
  UserAttributes: [
    { Name: 'email', Value: string },
    { Name: 'given_name', Value: string },
    { Name: 'family_name', Value: string },
    { Name: 'email_verified', Value: 'false' }
  ];
  MessageAction: 'SUPPRESS'; // Prevent Cognito default emails
  DesiredDeliveryMediums: ['EMAIL'];
}

interface UserGroupAssignment {
  GroupName: 'employees'; // Default group assignment
  UserPoolId: 'eu-central-1_LFA9Rhk2y';
  Username: string; // User's email
}
```

### Form Validation Rules
- **Email:** RFC 5322 compliant, unique in Cognito User Pool
- **Password:** Minimum 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special character
- **Names:** 1-50 characters, alphabetic with spaces, hyphens, and apostrophes
- **Address:** Required fields with Swiss postal code validation (4-digit format)
- **Terms/Privacy:** Explicit acceptance required for legal compliance

### Error Handling Scenarios
- **Duplicate Email:** Clear message with login suggestion
- **Invalid Address:** Geocoding failure with manual coordinate option
- **Verification Timeout:** Token expiration with resend option
- **Cognito Failures:** Service unavailable with retry mechanism
- **Database Errors:** Transaction rollback with user notification
- **Email Delivery:** SES failures with alternative contact methods

### Performance Requirements
- **Registration Response:** Form submission processed within 3 seconds
- **Email Delivery:** Verification email sent within 30 seconds
- **Geocoding:** Address coordinate calculation within 2 seconds
- **Concurrent Registrations:** Support 50 simultaneous registrations
- **Verification Processing:** Email verification completed within 1 second

### Testing Strategy
- **Test Location:** 
  - Frontend: `apps/web/src/app/features/auth/components/__tests__/`
  - Backend: `apps/api/src/handlers/auth/__tests__/`
  - Integration: `apps/api/src/services/registration/__tests__/`
- **Test Standards:** 
  - Registration form validation testing with invalid inputs
  - Email verification flow testing with expired tokens
  - Geocoding integration testing with various address formats
  - Cognito integration testing with user creation and group assignment
- **Testing Frameworks:** 
  - Frontend: Angular Testing Utilities with Jest
  - Backend: Node.js with Jest for registration handlers
  - E2E: Playwright for complete registration workflow
- **Specific Requirements:**
  - Test registration with duplicate emails
  - Test password validation with various invalid formats
  - Test address geocoding with Swiss addresses
  - Test email verification with expired and invalid tokens
  - Test integration with existing authentication system
  - Test backward compatibility with existing users
  - Test mobile responsive registration form
  - Test registration rate limiting and security measures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-12 | 1.0 | Initial detailed story creation for Epic 5 User Management | Story Manager |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*