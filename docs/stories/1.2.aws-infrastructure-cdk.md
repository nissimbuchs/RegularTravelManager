# Story 1.2: AWS Infrastructure with CDK

## Status
Approved

## Story
**As a** developer,
**I want** AWS infrastructure defined and deployable using CDK,
**so that** I can provision RDS PostgreSQL, Cognito, API Gateway, and Lambda resources consistently across environments.

## Acceptance Criteria
1. CDK project created in `infrastructure/` directory with TypeScript configuration
2. RDS PostgreSQL instance configured in EU-Central-1 with PostGIS extension enabled
3. Amazon Cognito User Pool created with user groups for 'employees' and 'managers'
4. API Gateway configured with CORS, authorization, and lambda proxy integration
5. IAM roles and policies created for Lambda functions to access RDS and Cognito
6. AWS SES domain identity verified and configured for production email sending
7. Environment-specific parameter management configured for dev, staging, and production
8. CDK deployment succeeds and creates all AWS resources without errors

## Tasks / Subtasks
- [ ] Set up CDK project structure (AC: 1)
  - [ ] Initialize CDK app in infrastructure/ directory with TypeScript
  - [ ] Configure CDK project with proper TypeScript compilation
  - [ ] Set up environment-specific stack configuration
  - [ ] Configure CDK context and deployment settings

- [ ] Configure RDS PostgreSQL with PostGIS (AC: 2)
  - [ ] Create RDS PostgreSQL instance in EU-Central-1 region
  - [ ] Enable PostGIS extension for geographic calculations
  - [ ] Configure VPC and security groups for database access
  - [ ] Set up database credentials management via AWS Secrets Manager
  - [ ] Configure connection pooling for Lambda function access

- [ ] Set up Amazon Cognito User Pools (AC: 3)
  - [ ] Create Cognito User Pool with email-based authentication
  - [ ] Configure password policies meeting business security requirements
  - [ ] Create user groups for 'employees' and 'managers' 
  - [ ] Set up user pool client for frontend application
  - [ ] Configure JWT token settings and expiration policies

- [ ] Configure AWS Location Service for geocoding (AC: 4)
  - [ ] Create place index for European addresses (EU-Central-1 data provider)
  - [ ] Configure place index with appropriate search precision for Swiss addresses
  - [ ] Set up IAM permissions for Lambda functions to access Location Service
  - [ ] Test geocoding accuracy with sample Swiss addresses

- [ ] Configure API Gateway (AC: 4)
  - [ ] Create REST API Gateway with proper resource structure
  - [ ] Configure CORS settings for Angular frontend integration
  - [ ] Set up Lambda proxy integration for all API routes
  - [ ] Configure custom authorizer for JWT token validation
  - [ ] Set up API Gateway stages for different environments

- [ ] Create IAM roles and policies (AC: 5)
  - [ ] Create Lambda execution role with basic Lambda permissions
  - [ ] Add RDS access permissions for database operations
  - [ ] Add Cognito access permissions for user management
  - [ ] Add SES permissions for email notifications
  - [ ] Add AWS Location Service permissions for geocoding
  - [ ] Configure least-privilege access principles

- [ ] Configure environment management (AC: 6)
  - [ ] Set up environment-specific parameter stores
  - [ ] Configure dev, staging, and production environment variables
  - [ ] Set up environment-specific resource naming conventions
  - [ ] Configure environment-specific scaling and performance settings

- [ ] Configure AWS SES for email notifications (AC: 2)
  - [ ] Set up SES domain identity for business email domain
  - [ ] Configure SPF, DKIM, and DMARC records for email authentication
  - [ ] Request production access (move out of SES sandbox)
  - [ ] Create email templates for request notifications
  - [ ] Configure bounce and complaint handling

- [ ] Deploy and validate infrastructure (AC: 8)
  - [ ] Deploy CDK stack to development environment
  - [ ] Validate all AWS resources are created successfully
  - [ ] Test database connectivity and PostGIS functionality
  - [ ] Validate Cognito user pool and JWT token generation
  - [ ] Test API Gateway endpoints with proper CORS headers
  - [ ] Verify SES domain verification and test email sending
  - [ ] Test AWS Location Service geocoding with sample Swiss addresses
  - [ ] Run infrastructure health checks and monitoring validation
  - [ ] Validate resource tagging and cost allocation setup

## Dev Notes

### Architecture Context
From the architecture document (docs/architecture.md):
- **Platform:** AWS Full Stack with serverless architecture
- **Key Services:** S3 + CloudFront (frontend), Lambda + API Gateway (backend), RDS PostgreSQL (data), Cognito (auth), SES (notifications)
- **Region:** EU-Central-1 (Frankfurt) for Swiss data residency compliance
- **Infrastructure as Code:** AWS CDK 2.100+ in TypeScript

### AWS Services Configuration
- **RDS PostgreSQL:** Version 15+ with PostGIS extension for geographic calculations
- **Amazon Cognito:** User pools with employee/manager groups and JWT tokens
- **Lambda:** Node.js Runtime v20 with TypeScript
- **API Gateway:** REST API with Lambda proxy integration
- **CloudFront:** Global CDN for Angular app distribution
- **AWS Location Service:** Place index for geocoding Swiss addresses with EU data residency

### Security Requirements
- **Data Residency:** EU-Central-1 region for Swiss compliance (NFR4)
- **Encryption:** HTTPS/TLS for all data transmission (NFR6)
- **Authentication:** JWT tokens with proper expiration and refresh (NFR7)
- **Access Control:** Role-based permissions for employees vs managers (FR14)

### Performance Requirements
- **Response Time:** API calls must be under 500ms (NFR1)
- **Concurrency:** Support up to 100 concurrent users (NFR9)
- **Connection Pooling:** RDS Proxy for Lambda database efficiency (NFR2)

### Testing
- **Test Location:** infrastructure/test/ directory
- **Test Standards:** CDK unit tests and integration tests
- **Testing Frameworks:** AWS CDK Testing Library with Jest
- **Specific Requirements:** 
  - Test stack synthesis without errors
  - Test IAM policy compliance
  - Test resource configuration validity
  - Integration test with actual AWS deployment

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 1 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*