# Story 4.2: Request Modification & Withdrawal

## Status
Approved

## Story
**As an** employee,
**I want** to modify or withdraw my travel requests before and after approval with proper workflow handling,
**so that** I can adapt to changing business needs and project requirements.

## Acceptance Criteria
1. Request modification interface allows employees to edit project, days per week, justification, and manager assignment for pending requests
2. Post-approval modification workflow requires manager re-approval with change tracking and approval history preservation
3. Request withdrawal functionality enables employees to cancel requests with withdrawal reasons and automatic status updates
4. Change impact analysis shows recalculated allowances and highlights significant changes requiring manager attention
5. Notification system alerts managers of modifications requiring review with change summaries and approval links
6. Modification history tracking maintains complete audit trail of all changes with timestamps and reasons
7. Business rule validation prevents modifications that violate company policies or create approval conflicts

## Tasks / Subtasks
- [ ] Create request modification interface (AC: 1)
  - [ ] Build modification form pre-populated with current request data
  - [ ] Allow editing of project, subproject, and manager assignments
  - [ ] Enable days per week adjustments with validation
  - [ ] Add justification text modification with change highlighting
  - [ ] Implement real-time recalculation of allowances during editing
  - [ ] Create modification preview with before/after comparison

- [ ] Implement post-approval modification workflow (AC: 2)
  - [ ] Create manager re-approval workflow for approved request changes
  - [ ] Build change tracking system to preserve original approval data
  - [ ] Implement approval history preservation with modification markers
  - [ ] Add version control for request data with change diffs
  - [ ] Create automatic status transition from approved to under review
  - [ ] Build notification system for managers about modification requests

- [ ] Build request withdrawal functionality (AC: 3)
  - [ ] Create withdrawal confirmation dialog with reason selection
  - [ ] Implement automatic status update to withdrawn state
  - [ ] Add withdrawal reason tracking for business intelligence
  - [ ] Create notification system for managers about withdrawn requests
  - [ ] Implement withdrawal reversal capability within time limits
  - [ ] Build withdrawal impact analysis for approved requests

- [ ] Add change impact analysis (AC: 4)
  - [ ] Create allowance recalculation engine for modifications
  - [ ] Build change highlighting system for significant modifications
  - [ ] Implement budget impact calculation for financial changes
  - [ ] Add policy violation detection for proposed changes
  - [ ] Create manager attention flags for high-impact modifications
  - [ ] Build change summary generation for notification content

- [ ] Implement modification notification system (AC: 5)
  - [ ] Create manager alerts for modification requests requiring approval
  - [ ] Build change summary emails with before/after comparisons
  - [ ] Add direct approval links in notification emails
  - [ ] Implement notification escalation for delayed responses
  - [ ] Create notification batching for multiple modifications
  - [ ] Build notification preferences for modification alerts

- [ ] Create modification history tracking (AC: 6)
  - [ ] Build comprehensive change log with all modification details
  - [ ] Store timestamps and user information for all changes
  - [ ] Create modification reason tracking with categorization
  - [ ] Implement change visualization with timeline display
  - [ ] Add search and filtering capabilities for modification history
  - [ ] Create export functionality for modification audit reports

- [ ] Add business rule validation (AC: 7)
  - [ ] Implement policy compliance checking for modifications
  - [ ] Create validation rules for maximum change limits
  - [ ] Add conflict detection with existing approvals or schedules
  - [ ] Build business logic validation for company-specific rules
  - [ ] Implement approval threshold checking for significant changes
  - [ ] Create validation error messaging with correction guidance

## Dev Notes

### Architecture Context
From the architecture document:
- **Workflow Engine:** State machine handling for complex modification workflows
- **Change Tracking:** Version control system for request data changes
- **Validation Engine:** Business rule enforcement with configurable policies
- **Notification System:** Automated alerts for modification events

### Business Requirements
From PRD requirements:
- **Request Flexibility:** Employee ability to modify requests as needs change
- **Manager Control:** Re-approval workflow for significant modifications
- **Audit Trail:** Complete tracking of all request modifications (FR12)
- **Business Rules:** Policy enforcement and compliance validation

### Request Modification Data Model
```typescript
interface RequestModification {
  id: string;
  requestId: string;
  modifiedBy: string;
  modificationType: ModificationType;
  timestamp: Date;
  reason: string;
  category: ModificationCategory;
  changes: FieldChange[];
  requiresApproval: boolean;
  approvalStatus: ModificationApprovalStatus;
  impactAnalysis: ModificationImpact;
}

enum ModificationType {
  PROJECT_CHANGE = 'project_change',
  SCHEDULE_CHANGE = 'schedule_change',
  MANAGER_CHANGE = 'manager_change',
  JUSTIFICATION_UPDATE = 'justification_update',
  WITHDRAWAL = 'withdrawal'
}

interface FieldChange {
  field: string;
  oldValue: any;
  newValue: any;
  significance: 'low' | 'medium' | 'high';
  requiresManagerAttention: boolean;
}

interface ModificationImpact {
  allowanceChange: number; // CHF difference
  budgetImpact: BudgetImpact;
  policyViolations: PolicyViolation[];
  conflictDetection: ConflictDetection[];
  significanceScore: number; // 0-10
}
```

### Modification Workflow States
```typescript
enum ModificationStatus {
  DRAFT = 'draft',
  SUBMITTED = 'submitted',
  UNDER_REVIEW = 'under_review',
  APPROVED = 'approved',
  REJECTED = 'rejected',
  CANCELLED = 'cancelled'
}

interface ModificationWorkflow {
  requestId: string;
  currentStatus: ModificationStatus;
  previousStatus: ModificationStatus;
  workflowSteps: WorkflowStep[];
  requiresManagerApproval: boolean;
  autoApprovalEligible: boolean;
  escalationRequired: boolean;
}
```

### Business Rule Validation
```typescript
interface BusinessRule {
  name: string;
  description: string;
  applies: (modification: RequestModification) => boolean;
  validate: (modification: RequestModification) => ValidationResult;
  severity: 'warning' | 'error' | 'info';
}

const modificationRules: BusinessRule[] = [
  {
    name: 'max_allowance_increase',
    description: 'Modifications cannot increase allowance by more than 50%',
    applies: (mod) => mod.impactAnalysis.allowanceChange > 0,
    validate: (mod) => validateAllowanceIncrease(mod, 0.5),
    severity: 'error'
  },
  {
    name: 'late_modification',
    description: 'Modifications within 48 hours require manager approval',
    applies: (mod) => isWithinHours(mod.timestamp, 48),
    validate: (mod) => ({ valid: mod.requiresApproval, message: 'Late modification requires approval' }),
    severity: 'warning'
  }
];
```

### Withdrawal Process
```typescript
interface WithdrawalRequest {
  requestId: string;
  withdrawnBy: string;
  withdrawalDate: Date;
  reason: WithdrawalReason;
  customReason?: string;
  impactAnalysis: WithdrawalImpact;
  reversible: boolean;
  reversalDeadline?: Date;
}

enum WithdrawalReason {
  PROJECT_CANCELLED = 'project_cancelled',
  SCHEDULE_CHANGED = 'schedule_changed',
  PERSONAL_CIRCUMSTANCES = 'personal_circumstances',
  BUDGET_CONSTRAINTS = 'budget_constraints',
  POLICY_CHANGES = 'policy_changes',
  OTHER = 'other'
}

interface WithdrawalImpact {
  budgetRelease: number;
  managerWorkloadReduction: number;
  scheduleConflictResolution: boolean;
  downstreamRequestsAffected: string[];
}
```

### Performance Requirements
- **Modification Processing:** Real-time validation and impact analysis within 2 seconds
- **Change Tracking:** Efficient storage and retrieval of modification history
- **Notification Delivery:** Modification alerts sent within 30 seconds
- **Business Rule Validation:** Rule processing within 500ms

### Testing
- **Test Location:** 
  - Frontend: apps/web/src/app/features/requests/modification/__tests__/
  - Backend: apps/api/src/services/modification/__tests__/
  - Workflow: apps/api/src/workflows/__tests__/modification/
- **Test Standards:** 
  - Modification workflow testing with various scenarios
  - Business rule validation testing with edge cases
  - Change impact analysis testing with calculations
- **Testing Frameworks:** 
  - Frontend: Angular Testing Utilities with Jest
  - Backend: Node.js with Jest for modification services
  - E2E: Playwright for complete modification workflows
- **Specific Requirements:**
  - Test request modification with all field types
  - Test post-approval modification workflow and re-approval
  - Test withdrawal functionality with impact analysis
  - Test change impact calculations and policy validation
  - Test modification notifications and manager alerts
  - Test modification history tracking and audit trails
  - Test business rule validation with various scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 4 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*