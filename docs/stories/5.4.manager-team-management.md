# Story 5.4: Manager Team Management

## Status
Approved

## Story
**As a** manager,
**I want** to view all employees assigned to me and manage their basic profile information within my authority,
**so that** I can maintain accurate team records and support my employees' travel request needs.

## Acceptance Criteria
1. Team dashboard displays all assigned employees with their current travel request status, recent activity, and profile completeness indicators
2. Employee profile view shows detailed information including home address, recent requests, approval patterns, and travel statistics within manager's scope
3. Manager can update limited employee information such as contact details, emergency contacts, and organizational assignments within their authority level
4. Team statistics provide actionable insights into travel patterns, expense trends, approval workflows, and budget utilization for management reporting
5. Employee search and filtering capabilities allow efficient team management for managers with large teams using various criteria and saved searches
6. Integration with existing approval workflows shows pending requests from team members with enhanced contextual information and priority indicators
7. Team management actions maintain proper audit trails and respect existing security boundaries with role-based data access controls
8. Manager authority validation ensures managers can only access and modify information for their assigned employees with proper hierarchy enforcement

## Tasks / Subtasks
- [ ] Create team management API endpoints (AC: 1, 2, 8)
  - [ ] Build `GET /api/manager/team` Lambda function with employee listing and filtering
  - [ ] Build `GET /api/manager/employees/{id}` endpoint with detailed employee information
  - [ ] Implement manager authority validation for all team operations
  - [ ] Add team statistics calculation and caching for performance
  - [ ] Create employee profile access control with manager scope validation
  - [ ] Add comprehensive audit logging for team management actions

- [ ] Implement limited employee profile management (AC: 3, 7)
  - [ ] Create `PUT /api/manager/employees/{id}` endpoint with restricted field updates
  - [ ] Implement field-level permission validation for manager updates
  - [ ] Add contact information and organizational assignment management
  - [ ] Create audit trail for manager-initiated employee changes
  - [ ] Implement approval workflow for sensitive employee changes
  - [ ] Add rollback capabilities for unauthorized changes

- [ ] Build team analytics and reporting (AC: 4)
  - [ ] Create `GET /api/manager/team/statistics` endpoint with comprehensive team analytics
  - [ ] Implement travel pattern analysis and trend reporting
  - [ ] Add budget tracking and expense analysis for team management
  - [ ] Create approval workflow efficiency metrics
  - [ ] Build comparative team performance analytics
  - [ ] Add predictive analytics for travel budget planning

- [ ] Create advanced search and filtering (AC: 5)
  - [ ] Build employee search with multiple criteria and real-time filtering
  - [ ] Implement saved search functionality for common team queries
  - [ ] Add advanced filtering by travel patterns, performance metrics, and status
  - [ ] Create employee grouping and categorization capabilities
  - [ ] Build export functionality for filtered team data
  - [ ] Add team member comparison and ranking features

- [ ] Build comprehensive team dashboard (AC: 1, 6)
  - [ ] Create `ManagerTeamComponent` with advanced team overview interface
  - [ ] Implement real-time team status monitoring with live updates
  - [ ] Build pending request integration with priority indicators
  - [ ] Create team member quick actions and shortcuts
  - [ ] Design mobile-responsive team management interface
  - [ ] Add customizable dashboard layout and widgets

- [ ] Implement workflow integration (AC: 6)
  - [ ] Integrate with existing approval workflow from Epic 3
  - [ ] Add enhanced contextual information for team member requests
  - [ ] Create priority indicators based on employee patterns and urgency
  - [ ] Build team-specific approval shortcuts and batch operations
  - [ ] Implement request escalation and delegation capabilities
  - [ ] Add team-wide communication and notification features

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [ ] **New Components/Pages** - Manager team dashboard with employee management capabilities
- [ ] **State Management** - RxJS service updates for team management operations:
  - [ ] `ManagerService` extension with team management methods
  - [ ] Team member state management with BehaviorSubjects
  - [ ] Team statistics and analytics state management
  - [ ] Employee search and filtering state management
- [ ] **Routing** - Manager-only protected routes with team access validation:
  - [ ] `/manager/team` - Main team management dashboard
  - [ ] `/manager/employees/{id}` - Individual team member details
  - [ ] `/manager/analytics` - Team analytics and reporting interface
- [ ] **API Integration** - HTTP services for manager team operations:
  - [ ] Team member listing and management services
  - [ ] Employee profile access and limited update services
  - [ ] Team analytics and reporting services
  - [ ] Enhanced approval workflow integration services

### Backend Changes
- [ ] **New API Endpoints** - Manager team management REST endpoints:
  - [ ] `GET /api/manager/team` - Team member listing with status and filtering
  - [ ] `GET /api/manager/employees/{id}` - Detailed team member information
  - [ ] `PUT /api/manager/employees/{id}` - Limited employee profile updates
  - [ ] `GET /api/manager/team/statistics` - Team analytics and performance metrics
  - [ ] `GET /api/manager/team/search` - Advanced employee search with filtering
  - [ ] `GET /api/manager/team/pending-requests` - Enhanced pending request context
  - [ ] `POST /api/manager/team/actions` - Bulk team operations and shortcuts
- [ ] **Lambda Functions** - New Lambda handlers for manager team operations:
  - [ ] Handler file: `apps/api/src/handlers/manager/list-team.ts`
  - [ ] Handler file: `apps/api/src/handlers/manager/get-employee-details.ts`
  - [ ] Handler file: `apps/api/src/handlers/manager/update-employee.ts`
  - [ ] Handler file: `apps/api/src/handlers/manager/team-statistics.ts`
  - [ ] Handler file: `apps/api/src/handlers/manager/search-team.ts`
  - [ ] Handler file: `apps/api/src/handlers/manager/team-actions.ts`
- [ ] **Database Changes** - Schema modifications for team management:
  - [ ] Migration script: `migrations/026-create-manager-team-views.sql`
  - [ ] Migration script: `migrations/027-create-team-analytics-tables.sql`
  - [ ] Manager team access optimization views
  - [ ] Team statistics and analytics aggregation tables
  - [ ] Manager action audit trail enhancements
- [ ] **Authentication** - Team access validation with existing role system:
  - [ ] Manager authority validation for team member access
  - [ ] Enhanced role-based data filtering for team operations
  - [ ] Manager hierarchy validation and enforcement

### Infrastructure Changes (AWS CDK)
- [ ] **API Gateway** - New routes for manager team operations:
  - File: `infrastructure/lib/api-gateway-stack.ts`
  - Routes: `/manager/team/*`, `/manager/employees/*`, `/manager/analytics/*`
- [ ] **Lambda Configuration** - Function definitions for team management:
  - File: `infrastructure/lib/lambda-stack.ts`
  - Functions: `listTeamFunction`, `getEmployeeDetailsFunction`, `teamStatisticsFunction`
- [ ] **Database** - RDS schema updates for team management:
  - Manager team access optimization views
  - Team analytics and performance tracking tables
  - Enhanced audit trail for manager actions
- [ ] **Environment Variables** - Team management configuration:
  - Development: `docker-compose.yml` - Team dashboard settings
  - Production: `infrastructure/lib/config/environment-config.ts` - Manager authority settings
- [ ] **IAM Permissions** - Team management permissions:
  - Employee data access within manager scope
  - Limited employee profile modification permissions
  - Team analytics and reporting access
- [ ] **Other AWS Services**:
  - AWS Cognito - Manager group validation and authority checking
  - CloudWatch - Team management operation monitoring
  - AWS SES - Team communication and notification templates

### Development Environment
- [ ] **Docker Services** - No changes required to existing services
- [ ] **LocalStack** - Team management testing with enhanced manager scope validation
- [ ] **Sample Data** - Manager-employee relationships and team scenarios
- [ ] **Environment Setup** - Team management workflow testing configuration

## Dev Notes

### Architecture Context
From the architecture document:
- **Manager Authority:** Enforces manager-employee relationships with proper hierarchy validation
- **Data Security:** Limits data access to assigned team members only with role-based filtering
- **Workflow Integration:** Seamlessly integrates with existing approval workflow capabilities
- **Performance Optimization:** Uses efficient queries and caching for large team management

### Existing System Integration
From brainstorming session and current implementation:
- **Approval Workflow:** Extends existing Epic 3 manager approval dashboard with team context
- **Employee Search:** Builds upon Epic 3 Story 3.5 employee search with manager scope limitations
- **Authentication System:** Uses existing JWT validation with enhanced manager authority checking
- **Travel Requests:** Integrates with existing travel request management and approval systems

### Security Requirements
From PRD non-functional requirements:
- **Role-Based Access:** Strict manager authority validation for all team operations (NFR14)
- **Data Security:** Encrypted transmission of all team data via HTTPS/TLS (NFR6)
- **Audit Compliance:** Comprehensive logging of manager team actions (NFR12)
- **Privacy Protection:** Appropriate data masking for sensitive employee information (NFR5)

### Manager Team Management Data Model
```typescript
interface ManagerTeam {
  manager: ManagerInfo;
  teamMembers: TeamMember[];
  teamStatistics: TeamStatistics;
  pendingRequests: PendingRequestSummary[];
  recentActivity: TeamActivity[];
}

interface TeamMember {
  id: string;
  employeeNumber: string;
  firstName: string;
  lastName: string;
  email: string;
  phoneNumber?: string;
  position: string;
  department: string;
  startDate: Date;
  status: 'active' | 'on_leave' | 'inactive';
  homeAddress: {
    city: string;
    postalCode: string;
    // Full address hidden for privacy
  };
  profileCompleteness: number; // Percentage
  lastLoginAt?: Date;
  recentActivity: ActivitySummary;
  travelStatistics: EmployeeTravelStats;
}

interface TeamMemberDetails extends TeamMember {
  contactInformation: {
    phoneNumber?: string;
    emergencyContact?: EmergencyContact;
    preferredCommunication: 'email' | 'phone' | 'both';
  };
  organizationalInfo: {
    position: string;
    department: string;
    startDate: Date;
    employmentType: 'full_time' | 'part_time' | 'contractor';
    workLocation: string;
  };
  travelHistory: TravelRequestSummary[];
  performanceMetrics: PerformanceMetrics;
  managerNotes?: string; // Manager-only field
}
```

### Team Statistics and Analytics
```typescript
interface TeamStatistics {
  teamSize: number;
  activeMembers: number;
  travelMetrics: {
    totalRequests: number;
    pendingRequests: number;
    approvedRequests: number;
    totalAllowanceAmount: number;
    averageRequestValue: number;
    monthlyTrends: MonthlyTravelTrend[];
  };
  budgetAnalysis: {
    totalBudgetUsed: number;
    budgetRemaining: number;
    projectedOverrun: number;
    costPerEmployee: number;
    budgetUtilizationRate: number;
  };
  approvalMetrics: {
    averageApprovalTime: number;
    approvalRate: number;
    rejectionReasons: RejectionReasonStats[];
    workflowEfficiency: number;
  };
  performanceIndicators: {
    highFrequencyTravelers: number;
    budgetConcernEmployees: number;
    complianceScore: number;
    teamEngagementScore: number;
  };
}

interface EmployeeTravelStats {
  totalRequests: number;
  approvedRequests: number;
  rejectedRequests: number;
  totalAllowanceEarned: number;
  averageRequestValue: number;
  lastRequestDate?: Date;
  frequencyPattern: TravelFrequency;
  complianceScore: number;
  trendDirection: 'increasing' | 'stable' | 'decreasing';
}
```

### Manager Authority and Permissions
```typescript
interface ManagerPermissions {
  canViewTeamProfiles: boolean;
  canEditContactInfo: boolean;
  canUpdateOrganizationalInfo: boolean;
  canViewTravelHistory: boolean;
  canAddManagerNotes: boolean;
  canExportTeamData: boolean;
  canViewTeamAnalytics: boolean;
  canPerformBulkActions: boolean;
}

interface ManagerAuthorityValidation {
  managerId: string;
  employeeId: string;
  isDirectReport: boolean;
  isWithinHierarchy: boolean;
  hasPermissionForAction: boolean;
  restrictedFields: string[];
  auditRequired: boolean;
}

interface TeamMemberUpdate {
  employeeId: string;
  updatedFields: {
    phoneNumber?: string;
    emergencyContact?: EmergencyContact;
    position?: string;
    department?: string;
    workLocation?: string;
    managerNotes?: string;
  };
  updateReason: string;
  requiresApproval: boolean;
}
```

### Team Search and Filtering
```typescript
interface TeamSearchCriteria {
  query?: string; // Name, email, or employee number
  department?: string;
  position?: string;
  status?: EmployeeStatus;
  travelActivity?: 'high' | 'medium' | 'low' | 'none';
  budgetConcern?: boolean;
  lastLoginBefore?: Date;
  joinedAfter?: Date;
  performanceRating?: 'excellent' | 'good' | 'needs_improvement';
}

interface SavedSearch {
  id: string;
  name: string;
  managerId: string;
  criteria: TeamSearchCriteria;
  createdAt: Date;
  lastUsed: Date;
  useCount: number;
}

interface TeamSearchResult {
  employees: TeamMember[];
  totalCount: number;
  filters: AppliedFilters;
  suggestions: SearchSuggestion[];
  exportOptions: ExportOption[];
}
```

### Enhanced Approval Workflow Integration
```typescript
interface TeamPendingRequests {
  requests: EnhancedPendingRequest[];
  priorityIndicators: PriorityIndicator[];
  bulkActionOptions: BulkActionOption[];
  teamContext: TeamApprovalContext;
}

interface EnhancedPendingRequest {
  requestId: string;
  employee: TeamMemberSummary;
  project: ProjectSummary;
  requestDetails: TravelRequestDetails;
  priority: 'high' | 'medium' | 'low';
  contextualInfo: {
    employeeTravelPattern: string;
    budgetImpact: number;
    previousSimilarRequests: number;
    approvalRecommendation: 'approve' | 'review' | 'reject';
  };
  managerActions: QuickAction[];
}

interface TeamApprovalContext {
  teamBudgetStatus: BudgetStatus;
  recentApprovalPatterns: ApprovalPattern[];
  teamTravelTrends: TravelTrend[];
  upcomingDeadlines: Deadline[];
}
```

### Manager Team Actions and Shortcuts
```sql
-- Manager team access optimization view
-- Note: Database uses snake_case for column names per SQL conventions
CREATE VIEW manager_team_view AS
SELECT 
  e.id,
  e.employee_number,
  e.first_name,
  e.last_name,
  e.email,
  e.phone_number,
  e.position,
  e.department,
  e.status,
  e.last_login_at,
  e.created_at as start_date,
  COUNT(tr.id) as total_requests,
  COUNT(CASE WHEN tr.status = 'pending' THEN 1 END) as pending_requests,
  COUNT(CASE WHEN tr.status = 'approved' THEN 1 END) as approved_requests,
  COALESCE(SUM(CASE WHEN tr.status = 'approved' THEN tr.calculated_allowance ELSE 0 END), 0) as total_allowance,
  MAX(tr.submitted_date) as last_request_date
FROM employees e
LEFT JOIN travel_requests tr ON e.id = tr.employee_id
WHERE e.is_active = TRUE
GROUP BY e.id, e.employee_number, e.first_name, e.last_name, e.email, 
         e.phone_number, e.position, e.department, e.status, e.last_login_at, e.created_at;
```

### Team Communication and Notifications
```typescript
interface TeamCommunication {
  type: 'announcement' | 'reminder' | 'policy_update' | 'budget_alert';
  recipients: TeamMember[];
  subject: string;
  message: string;
  priority: 'low' | 'medium' | 'high' | 'urgent';
  deliveryMethod: 'email' | 'in_app' | 'both';
  scheduledAt?: Date;
  attachments?: Attachment[];
}

interface TeamNotificationTemplate {
  id: string;
  name: string;
  type: NotificationType;
  template: string;
  variables: TemplateVariable[];
  managerId: string;
  lastUsed: Date;
}
```

### Performance Requirements
- **Team Dashboard Loading:** Team overview loads within 1 second for teams up to 100 members
- **Employee Search:** Team member search results within 200ms
- **Statistics Calculation:** Team analytics calculated within 3 seconds
- **Profile Updates:** Employee information updates processed within 1 second
- **Bulk Operations:** Process up to 50 team members within 10 seconds

### Testing Strategy
- **Test Location:**
  - Frontend: `apps/web/src/app/features/manager/team/components/__tests__/`
  - Backend: `apps/api/src/handlers/manager/__tests__/`
  - Integration: `apps/api/src/services/team-management/__tests__/`
- **Test Standards:**
  - Manager authority validation with proper hierarchy enforcement
  - Team member access controls with scope limitations
  - Limited employee profile updates with permission validation
  - Team analytics calculation with various scenarios
- **Testing Frameworks:**
  - Frontend: Angular Testing Utilities with Jest
  - Backend: Node.js with Jest for manager team handlers
  - E2E: Playwright for complete team management workflow
- **Specific Requirements:**
  - Test manager team dashboard with large teams (100+ members)
  - Test employee search and filtering with various criteria
  - Test limited profile updates with permission validation
  - Test team statistics calculation with historical data
  - Test manager authority validation with complex hierarchies
  - Test integration with existing approval workflow
  - Test mobile responsive team management interface
  - Test team member privacy protection and data masking
  - Test concurrent manager operations with data consistency
  - Test team communication and notification features
  - Test export functionality with filtered team data
  - Test saved search functionality with multiple criteria

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-12 | 1.0 | Initial detailed story creation for Epic 5 User Management | Story Manager |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*