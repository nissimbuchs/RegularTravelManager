# Story 5.2: User Profile Management

## Status
Approved

## Story
**As a** registered user,
**I want** to update my profile information, change my password, and manage account settings,
**so that** I can maintain accurate personal information and secure access to my account.

## Acceptance Criteria
1. Profile management interface allows updating first name, last name, home address, phone number, and notification preferences with proper validation
2. Password change functionality requires current password verification and enforces same complexity requirements as registration
3. Home address updates trigger automatic geocoding and recalculation of pending travel request distances using existing calculation engine
4. Profile changes maintain comprehensive audit trail with timestamps, change tracking, and responsible party logging for compliance
5. Email address changes require verification process to confirm new email ownership before updating Cognito and database records
6. Account settings allow users to configure notification preferences (email, frequency) and privacy settings within business requirements
7. Profile updates integrate seamlessly with existing authentication flow without requiring re-login or session invalidation
8. Changes to critical profile information require additional security confirmation (password re-entry) for enhanced security

## Tasks / Subtasks
- [ ] Create profile management API endpoints (AC: 1, 3, 4)
  - [ ] Build `GET /api/user/profile` Lambda function for profile retrieval
  - [ ] Build `PUT /api/user/profile` Lambda function with comprehensive validation
  - [ ] Implement automatic geocoding on address changes using existing PostGIS functions
  - [ ] Add profile change audit trail with comprehensive change tracking
  - [ ] Implement transaction handling for address updates affecting travel requests
  - [ ] Add input sanitization and validation middleware for profile data

- [ ] Implement password change system (AC: 2, 8)
  - [ ] Create `POST /api/user/change-password` endpoint with security validation
  - [ ] Implement current password verification using Cognito authentication
  - [ ] Add password complexity validation matching registration requirements
  - [ ] Create security confirmation for critical changes
  - [ ] Implement password change audit logging
  - [ ] Add rate limiting for password change attempts

- [ ] Build email change verification (AC: 5)
  - [ ] Create secure email change token generation system
  - [ ] Build `POST /api/user/change-email` endpoint with verification flow
  - [ ] Design email verification templates for address changes
  - [ ] Implement dual verification (old and new email confirmation)
  - [ ] Add Cognito email attribute synchronization
  - [ ] Create rollback mechanism for failed email changes

- [ ] Create profile frontend components (AC: 1, 6, 7)
  - [ ] Build `ProfileManagementComponent` with tabbed interface design
  - [ ] Implement real-time form validation with error handling
  - [ ] Create notification preferences management interface
  - [ ] Add privacy settings configuration options
  - [ ] Design mobile-responsive profile editing interface
  - [ ] Implement unsaved changes warning system

- [ ] Add distance recalculation integration (AC: 3)
  - [ ] Integrate with existing distance calculation engine from Story 2.3
  - [ ] Implement automatic travel request distance updates on address changes
  - [ ] Add progress indicators for recalculation processes
  - [ ] Create notification system for affected travel requests
  - [ ] Implement error handling for geocoding and calculation failures
  - [ ] Add audit logging for distance recalculations

- [ ] Implement comprehensive audit system (AC: 4)
  - [ ] Create profile change history tracking table
  - [ ] Implement field-level change tracking with before/after values
  - [ ] Add user activity logging for all profile operations
  - [ ] Create administrative audit trail viewing interface
  - [ ] Implement data retention policies for audit records
  - [ ] Add compliance reporting for profile changes

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [ ] **New Components/Pages** - Profile management interface with settings
- [ ] **State Management** - RxJS service updates for profile state management:
  - [ ] `UserService` extension with profile management methods
  - [ ] Profile state management with BehaviorSubjects
  - [ ] Form validation state management for profile updates
  - [ ] Notification preferences state management
- [ ] **Routing** - Protected profile management routes:
  - [ ] `/profile` - Main profile management interface
  - [ ] `/profile/security` - Password and security settings
  - [ ] `/profile/notifications` - Notification preferences
- [ ] **API Integration** - HTTP services for profile operations:
  - [ ] Profile retrieval and update services
  - [ ] Password change service integration
  - [ ] Email verification service integration

### Backend Changes
- [ ] **New API Endpoints** - Profile management REST endpoints:
  - [ ] `GET /api/user/profile` - Retrieve user profile information
  - [ ] `PUT /api/user/profile` - Update profile with validation and geocoding
  - [ ] `POST /api/user/change-password` - Password change with security validation
  - [ ] `POST /api/user/change-email` - Email change with verification flow
  - [ ] `GET /api/user/profile/history` - Profile change audit history
- [ ] **Lambda Functions** - New Lambda handlers for profile management:
  - [ ] Handler file: `apps/api/src/handlers/user/get-profile.ts`
  - [ ] Handler file: `apps/api/src/handlers/user/update-profile.ts`
  - [ ] Handler file: `apps/api/src/handlers/user/change-password.ts`
  - [ ] Handler file: `apps/api/src/handlers/user/change-email.ts`
  - [ ] Handler file: `apps/api/src/handlers/user/profile-history.ts`
- [ ] **Database Changes** - Schema modifications for profile management:
  - [ ] Migration script: `migrations/022-enhance-employee-profile-fields.sql`
  - [ ] Migration script: `migrations/023-create-employee-profile-history.sql`
  - [ ] Employee table enhancements for additional profile fields
  - [ ] Profile change history table with comprehensive audit trail
- [ ] **Authentication** - Profile integration with existing authentication:
  - [ ] Profile updates within existing JWT validation framework
  - [ ] Cognito attribute synchronization for email changes
  - [ ] Session management during profile updates

### Infrastructure Changes (AWS CDK)
- [ ] **API Gateway** - New routes for profile management:
  - File: `infrastructure/lib/api-gateway-stack.ts`
  - Routes: `/user/profile`, `/user/change-password`, `/user/change-email`
- [ ] **Lambda Configuration** - Function definitions for profile operations:
  - File: `infrastructure/lib/lambda-stack.ts`
  - Functions: `getProfileFunction`, `updateProfileFunction`, `changePasswordFunction`
- [ ] **Database** - RDS schema updates for profile management:
  - Enhanced employee profile fields (phone, preferences)
  - Profile change history table with audit trail
  - Indexes for efficient profile queries
- [ ] **Environment Variables** - Profile management configuration:
  - Development: `docker-compose.yml` - Profile and geocoding settings
  - Production: `infrastructure/lib/config/environment-config.ts` - Security settings
- [ ] **IAM Permissions** - Service permissions for profile operations:
  - Cognito user attribute modification permissions
  - PostGIS geocoding access for address updates
  - SES permissions for email change verification
- [ ] **Other AWS Services**:
  - AWS Cognito - User attribute synchronization
  - AWS SES - Email change verification templates
  - CloudWatch - Profile operation monitoring

### Development Environment
- [ ] **Docker Services** - No changes required to existing services
- [ ] **LocalStack** - Profile management testing with Cognito mocking
- [ ] **Sample Data** - Profile update test scenarios
- [ ] **Environment Setup** - Profile management workflow testing

## Dev Notes

### Architecture Context
From the architecture document:
- **Profile Integration:** Extends existing employee records with additional profile fields
- **Geocoding Integration:** Uses existing PostGIS functions for address coordinate updates
- **Authentication Compatibility:** Maintains existing JWT validation and session management
- **Audit Compliance:** Comprehensive change tracking for Swiss business compliance

### Existing System Integration
From brainstorming session and current implementation:
- **Distance Calculation:** Address changes trigger recalculation using existing Story 2.3 engine
- **Travel Requests:** Profile updates affect pending request distances automatically
- **Email System:** Leverages existing SES configuration for verification emails
- **Role Management:** Profile changes respect existing role-based access controls

### Security Requirements
From PRD non-functional requirements:
- **Data Encryption:** All profile data transmitted via HTTPS/TLS (NFR6)
- **Input Validation:** Comprehensive client and server-side validation (NFR5)
- **Session Security:** JWT token validation for all profile operations (NFR7)
- **Audit Trail:** Complete change tracking for compliance reporting (NFR12)

### Profile Management Data Model
```typescript
interface UserProfile {
  id: string; // UUID
  email: string;
  firstName: string;
  lastName: string;
  phoneNumber?: string;
  homeAddress: {
    street: string;
    city: string;
    postalCode: string;
    country: string;
  };
  homeCoordinates: {
    latitude: number;
    longitude: number;
  };
  notificationPreferences: {
    email: boolean;
    requestUpdates: boolean;
    weeklyDigest: boolean;
    maintenanceAlerts: boolean;
  };
  privacySettings: {
    profileVisibility: 'private' | 'team' | 'company';
    allowAnalytics: boolean;
  };
  lastUpdatedAt: Date;
  lastLoginAt: Date;
}

interface ProfileUpdateRequest {
  firstName?: string;
  lastName?: string;
  phoneNumber?: string;
  homeAddress?: {
    street: string;
    city: string;
    postalCode: string;
    country: string;
  };
  notificationPreferences?: NotificationPreferences;
  privacySettings?: PrivacySettings;
}

interface ProfileChangeHistory {
  id: string;
  employeeId: string;
  changedFields: string[];
  oldValues: Record<string, any>;
  newValues: Record<string, any>;
  changeReason?: string;
  changedBy: string; // User ID who made the change
  changedAt: Date;
  ipAddress: string;
  userAgent: string;
}
```

### Password Change Security
```typescript
interface PasswordChangeRequest {
  currentPassword: string;
  newPassword: string;
  confirmPassword: string;
}

interface PasswordChangeValidation {
  currentPasswordValid: boolean;
  newPasswordComplexity: boolean;
  passwordsMatch: boolean;
  notRecentlyUsed: boolean; // Check last 5 passwords
  meetsCognitoPolicy: boolean;
}

interface SecurityConfirmationRequired {
  criticalFields: ['email', 'homeAddress', 'notificationPreferences'];
  confirmationMethod: 'password' | 'sms' | 'email';
  confirmationTimeout: 300; // 5 minutes
}
```

### Email Change Verification Flow
```typescript
interface EmailChangeProcess {
  step1: 'User requests email change with new email address';
  step2: 'System sends verification to current email address';
  step3: 'User confirms change from current email';
  step4: 'System sends verification to new email address';
  step5: 'User confirms new email ownership';
  step6: 'System updates Cognito email attribute';
  step7: 'System updates employee database record';
  step8: 'System sends confirmation to both email addresses';
}

interface EmailChangeToken {
  id: string;
  employeeId: string;
  currentEmail: string;
  newEmail: string;
  currentEmailToken: string;
  newEmailToken: string;
  currentEmailVerified: boolean;
  newEmailVerified: boolean;
  expiresAt: Date;
  createdAt: Date;
}
```

### Address Update & Geocoding
```sql
-- Function to handle address updates with geocoding
-- Note: Database uses snake_case for column names per SQL conventions
CREATE OR REPLACE FUNCTION update_employee_address(
  employee_id UUID,
  new_address TEXT,
  new_city TEXT,
  new_postal_code TEXT,
  new_country TEXT DEFAULT 'Switzerland'
) RETURNS TABLE(
  coordinates POINT,
  affected_requests INTEGER
) AS $$
DECLARE
  new_coordinates POINT;
  request_count INTEGER;
BEGIN
  -- Geocode the new address
  SELECT geocode_address(new_address, new_city, new_postal_code, new_country) 
  INTO new_coordinates;
  
  -- Update employee record
  UPDATE employees 
  SET home_address = new_address,
      home_coordinates = new_coordinates,
      profile_updated_at = CURRENT_TIMESTAMP
  WHERE id = employee_id;
  
  -- Count affected pending travel requests
  SELECT COUNT(*) INTO request_count
  FROM travel_requests 
  WHERE employee_id = employee_id 
    AND status = 'pending';
  
  -- Trigger recalculation of distances for pending requests
  -- This will be handled by the application layer
  
  RETURN QUERY SELECT new_coordinates, request_count;
END;
$$ LANGUAGE plpgsql;
```

### Notification Preferences Management
```typescript
interface NotificationPreferences {
  email: boolean; // Master email notification toggle
  requestUpdates: boolean; // Request status changes
  weeklyDigest: boolean; // Weekly summary of activity
  maintenanceAlerts: boolean; // System maintenance notifications
  frequency: 'immediate' | 'daily' | 'weekly';
  quietHours: {
    enabled: boolean;
    start: string; // HH:MM format
    end: string; // HH:MM format
    timezone: string; // Europe/Zurich
  };
}

interface PrivacySettings {
  profileVisibility: 'private' | 'team' | 'company';
  allowAnalytics: boolean;
  shareLocationData: boolean;
  allowManagerAccess: boolean;
  dataRetentionConsent: boolean;
}
```

### Travel Request Impact Handling
```typescript
interface AddressChangeImpact {
  affectedRequests: TravelRequest[];
  distanceChanges: DistanceChange[];
  allowanceChanges: AllowanceChange[];
  managerNotifications: ManagerNotification[];
}

interface DistanceChange {
  requestId: string;
  oldDistance: number;
  newDistance: number;
  oldAllowance: number;
  newAllowance: number;
  percentageChange: number;
}

interface RecalculationResult {
  success: boolean;
  processedRequests: number;
  failedRequests: number;
  totalImpact: {
    increaseCount: number;
    decreaseCount: number;
    totalDifference: number;
  };
}
```

### Form Validation Rules
- **Names:** 1-50 characters, alphabetic with spaces, hyphens, apostrophes
- **Phone:** Optional, Swiss phone number format validation
- **Address:** Required fields with Swiss postal code validation
- **Email:** RFC 5322 compliant, unique in system
- **Password:** Same complexity as registration (8+ chars, mixed case, numbers, specials)
- **Notification Preferences:** Boolean validation with business rule constraints

### Error Handling Scenarios
- **Geocoding Failure:** Address validation failure with manual coordinate option
- **Cognito Update Failure:** Service unavailable with retry mechanism
- **Database Transaction Failure:** Rollback with user notification
- **Email Verification Failure:** Alternative verification methods
- **Distance Recalculation Failure:** Partial success handling with retry
- **Concurrent Updates:** Optimistic locking with conflict resolution

### Performance Requirements
- **Profile Load:** Profile data retrieval within 300ms
- **Update Processing:** Profile updates processed within 2 seconds
- **Geocoding:** Address coordinate calculation within 2 seconds
- **Distance Recalculation:** Pending request updates within 5 seconds
- **Audit Logging:** Change history recording within 500ms

### Testing Strategy
- **Test Location:**
  - Frontend: `apps/web/src/app/features/profile/components/__tests__/`
  - Backend: `apps/api/src/handlers/user/__tests__/`
  - Integration: `apps/api/src/services/profile/__tests__/`
- **Test Standards:**
  - Profile form validation with various invalid inputs
  - Password change security with current password verification
  - Email change verification with dual confirmation flow
  - Address update geocoding with Swiss address formats
- **Testing Frameworks:**
  - Frontend: Angular Testing Utilities with Jest
  - Backend: Node.js with Jest for profile handlers
  - E2E: Playwright for complete profile management workflow
- **Specific Requirements:**
  - Test profile updates with invalid data formats
  - Test password change with incorrect current password
  - Test email change verification flow with timeouts
  - Test address geocoding with various Swiss addresses
  - Test travel request distance recalculation on address changes
  - Test audit trail generation for profile changes
  - Test notification preferences with business rule validation
  - Test mobile responsive profile interface
  - Test concurrent profile updates with conflict resolution

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-12 | 1.0 | Initial detailed story creation for Epic 5 User Management | Story Manager |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*