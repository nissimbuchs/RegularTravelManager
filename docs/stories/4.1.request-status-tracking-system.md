# Story 4.1: Request Status Tracking System

## Status
Approved

## Story
**As a** user (employee or manager),
**I want** to track travel request status in real-time with detailed progress indicators and history,
**so that** I understand exactly where each request stands in the approval workflow.

## Acceptance Criteria
1. Real-time status updates display current request state (submitted, under review, approved, rejected) with timestamp information
2. Progress indicator shows workflow stages with visual completion status and estimated time remaining for each stage
3. Status history timeline presents complete audit trail of all status changes with manager names and timestamps
4. Automated notifications alert users when status changes occur via email and in-app notifications
5. Request details page shows current assignee, processing queue position, and expected resolution timeframe
6. Status filtering allows users to view requests by current status with saved filter preferences
7. Mobile-responsive status tracking works seamlessly across desktop, tablet, and mobile devices

## Tasks / Subtasks
- [ ] Implement real-time status updates (AC: 1)
  - [ ] Create WebSocket connection for live status updates
  - [ ] Build status change event system with real-time broadcasting
  - [ ] Implement optimistic UI updates with rollback capabilities
  - [ ] Create status badge components with consistent visual design
  - [ ] Add timestamp formatting with localized time zones
  - [ ] Build fallback polling system for WebSocket failures

- [ ] Build progress indicator system (AC: 2)
  - [ ] Create multi-stage progress bar with workflow visualization
  - [ ] Implement completion percentage calculation for each stage
  - [ ] Add estimated time remaining based on historical processing times
  - [ ] Build stage-specific information tooltips and descriptions
  - [ ] Create adaptive progress display for different request types
  - [ ] Add visual indicators for delays or urgent requests

- [ ] Create status history timeline (AC: 3)
  - [ ] Build chronological timeline component with expandable details
  - [ ] Display manager names and role information for each action
  - [ ] Add status change timestamps with precise time tracking
  - [ ] Implement comment and feedback display in timeline
  - [ ] Create export functionality for status history records
  - [ ] Add search and filter capabilities within timeline

- [ ] Implement notification system (AC: 4)
  - [ ] Create automated email notifications for status changes
  - [ ] Build in-app notification system with toast messages
  - [ ] Add notification preferences management for users
  - [ ] Implement notification batching to prevent spam
  - [ ] Create notification history and read/unread tracking
  - [ ] Add push notifications for mobile application users

- [ ] Build request details interface (AC: 5)
  - [ ] Display current assignee with manager contact information
  - [ ] Show processing queue position and estimated wait times
  - [ ] Add expected resolution timeframe based on SLA targets
  - [ ] Create workload indicators for assigned managers
  - [ ] Implement request priority display with urgency indicators
  - [ ] Add escalation status and automatic escalation triggers

- [ ] Add status filtering capabilities (AC: 6)
  - [ ] Create status filter dropdown with multi-select options
  - [ ] Implement saved filter preferences with user profiles
  - [ ] Add quick filter buttons for common status combinations
  - [ ] Build advanced filtering with date ranges and managers
  - [ ] Create filter sharing capabilities for team managers
  - [ ] Implement filter performance optimization for large datasets

- [ ] Create mobile-responsive design (AC: 7)
  - [ ] Build responsive status tracking interface for mobile devices
  - [ ] Implement touch-friendly interactions and gestures
  - [ ] Create mobile-optimized progress indicators and timelines
  - [ ] Add offline status caching for intermittent connectivity
  - [ ] Build mobile push notification integration
  - [ ] Implement mobile-specific navigation and user experience

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [ ] **New Components/Pages** - Status tracking dashboard and timeline components
- [ ] **State Management** - NgRx actions/effects for real-time status updates
- [ ] **Routing** - Status tracking routes and deep linking
- [ ] **API Integration** - WebSocket connections and REST APIs for status data

### Backend Changes
- [ ] **New API Endpoints** - List all new REST endpoints:
  - [ ] `GET /requests/{id}/status` - Get current request status
  - [ ] `GET /requests/{id}/timeline` - Get complete status history
  - [ ] `GET /requests/queue-position/{id}` - Get processing queue position
  - [ ] `POST /notifications/preferences` - Manage notification settings
- [ ] **Lambda Functions** - New Lambda handlers required:
  - [ ] Handler file: `apps/api/src/handlers/status/get-status.ts`
  - [ ] Handler file: `apps/api/src/handlers/status/get-timeline.ts`
  - [ ] Handler file: `apps/api/src/handlers/status/update-status.ts`
  - [ ] Handler file: `apps/api/src/handlers/notifications/send-status-update.ts`
- [ ] **Database Changes** - Schema modifications needed:
  - [ ] Migration script: `migrations/013-create-status-tracking.sql`
  - [ ] Migration script: `migrations/014-create-notification-preferences.sql`
  - [ ] New tables: status_history, notification_preferences, processing_queue
- [ ] **Authentication** - Auth/authorization changes:
  - [ ] User-based status access controls
  - [ ] Manager visibility into all assigned requests

### Infrastructure Changes (AWS CDK)
- [ ] **API Gateway** - New routes/methods:
  - File: `infrastructure/src/api-gateway-stack.ts`
  - Routes: /requests/{id}/status, /requests/{id}/timeline
  - WebSocket API for real-time updates
- [ ] **Lambda Configuration** - Function definitions:
  - File: `infrastructure/src/lambda-stack.ts`
  - Functions: getStatusFunction, getTimelineFunction, statusUpdateFunction
- [ ] **Database** - RDS changes:
  - Status tracking tables with efficient indexes
- [ ] **Environment Variables** - New config needed:
  - Development: `docker-compose.yml` - WebSocket endpoints
  - Production: `infrastructure/src/parameter-store.ts` - Notification settings
- [ ] **IAM Permissions** - New service permissions:
  - rds-db:connect for status queries
  - execute-api:ManageConnections for WebSocket
- [ ] **Other AWS Services**:
  - AWS API Gateway WebSocket - Real-time status updates
  - AWS SNS - Push notifications
  - CloudWatch Events - Automated status updates

### Development Environment
- [ ] **Docker Services** - WebSocket development server
- [ ] **LocalStack** - WebSocket API mocking
- [ ] **Sample Data** - Status tracking test scenarios
- [ ] **Environment Setup** - Real-time development environment

## Dev Notes

### Architecture Context
From the architecture document:
- **Real-time Updates:** WebSocket integration for live status broadcasting
- **State Management:** NgRx for complex status state and caching
- **Mobile Support:** Progressive Web App capabilities for mobile access
- **Performance:** Efficient data loading and caching strategies

### Business Requirements
From PRD requirements:
- **Status Transparency:** Complete visibility into request lifecycle (FR9)
- **Real-time Updates:** Immediate notification of status changes
- **Mobile Access:** Full functionality across all device types (NFR3)
- **Audit Trail:** Complete tracking of all status changes (FR12)

### Request Status Data Model
```typescript
enum RequestStatus {
  DRAFT = 'draft',
  SUBMITTED = 'submitted',
  UNDER_REVIEW = 'under_review',
  ADDITIONAL_INFO_REQUIRED = 'additional_info_required',
  APPROVED = 'approved',
  REJECTED = 'rejected',
  WITHDRAWN = 'withdrawn',
  EXPIRED = 'expired'
}

interface RequestStatusUpdate {
  id: string;
  requestId: string;
  previousStatus: RequestStatus;
  newStatus: RequestStatus;
  timestamp: Date;
  updatedBy: string;
  updatedByRole: string;
  comment?: string;
  metadata: StatusUpdateMetadata;
}

interface StatusProgress {
  currentStage: WorkflowStage;
  completedStages: WorkflowStage[];
  remainingStages: WorkflowStage[];
  overallProgress: number; // 0-100%
  estimatedCompletionTime?: Date;
  isDelayed: boolean;
  delayReason?: string;
}

interface WorkflowStage {
  name: string;
  description: string;
  order: number;
  isCompleted: boolean;
  completedAt?: Date;
  assignee?: string;
  estimatedDuration: number; // minutes
}
```

### Real-time Status Broadcasting
```typescript
interface StatusBroadcastEvent {
  type: 'status_change' | 'assignment_change' | 'comment_added';
  requestId: string;
  employeeId: string;
  managerId: string;
  data: any;
  timestamp: Date;
}

// WebSocket event handling
class StatusUpdateService {
  private ws: WebSocket;
  
  subscribeToRequest(requestId: string): Observable<StatusBroadcastEvent> {
    return this.socketService.listen(`request:${requestId}`);
  }
  
  broadcastStatusChange(update: RequestStatusUpdate): void {
    this.ws.send(JSON.stringify({
      event: 'status_change',
      requestId: update.requestId,
      data: update
    }));
  }
}
```

### Status Processing SLA Targets
```typescript
interface StatusSLA {
  status: RequestStatus;
  targetProcessingTime: number; // hours
  escalationTrigger: number; // hours
  businessHoursOnly: boolean;
}

const statusSLAs: StatusSLA[] = [
  {
    status: RequestStatus.SUBMITTED,
    targetProcessingTime: 24,
    escalationTrigger: 48,
    businessHoursOnly: true
  },
  {
    status: RequestStatus.UNDER_REVIEW,
    targetProcessingTime: 72,
    escalationTrigger: 120,
    businessHoursOnly: true
  }
];
```

### Mobile-Specific Features
- **Offline Caching:** Cache recent status updates for offline viewing
- **Push Notifications:** Native mobile push notifications for status changes
- **Touch Gestures:** Swipe to refresh, pull to load more status history
- **Adaptive UI:** Different layouts optimized for phone vs tablet screens

### Performance Requirements
- **Real-time Latency:** Status updates delivered within 1 second
- **Page Load Time:** Status tracking page loads within 500ms
- **Mobile Performance:** Smooth interactions on mobile devices
- **Concurrent Users:** Support 1000+ concurrent status tracking sessions

### Testing
- **Test Location:** 
  - Frontend: apps/web/src/app/features/tracking/components/__tests__/
  - Real-time: apps/web/src/app/services/__tests__/websocket/
  - Backend: apps/api/src/services/status/__tests__/
- **Test Standards:** 
  - Real-time status update testing with WebSocket mocks
  - Mobile responsive testing across device breakpoints
  - Status workflow testing with various scenarios
- **Testing Frameworks:** 
  - Frontend: Angular Testing Utilities with Jest
  - Real-time: WebSocket testing with mock servers
  - E2E: Playwright with mobile device emulation
- **Specific Requirements:**
  - Test real-time status updates and WebSocket connectivity
  - Test progress indicator calculations and visualizations
  - Test status history timeline with large datasets
  - Test notification system with email and in-app alerts
  - Test mobile responsive design on various screen sizes
  - Test offline functionality and status caching
  - Test performance with high-volume status updates

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 4 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*