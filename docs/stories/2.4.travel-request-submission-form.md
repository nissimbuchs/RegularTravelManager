# Story 2.4: Travel Request Submission Form

## Status
Approved

## Story
**As an** employee,
**I want** to submit travel allowance requests with immediate calculation feedback,
**so that** I can see the daily and weekly allowance amounts before submitting my request.

## Acceptance Criteria
1. Request form provides dropdowns for project selection, subproject selection, and manager name input field
2. Days per week input accepts values 1-7 with validation and error messaging for invalid ranges
3. Justification text area requires minimum 10 characters with counter display and maximum 500 character limit
4. Real-time calculation display shows distance, daily allowance, and weekly total as user completes form fields
5. Form validation prevents submission with missing required fields or invalid data
6. Successful submission displays confirmation with request ID and calculated allowance summary
7. Form auto-saves draft data to prevent loss during session interruptions

## Tasks / Subtasks
- [ ] Create Angular request submission form (AC: 1)
  - [ ] Design form layout using Angular Material components
  - [ ] Implement project dropdown with async data loading
  - [ ] Create filtered subproject dropdown based on project selection
  - [ ] Add manager name input with autocomplete functionality
  - [ ] Implement responsive form design for mobile and desktop

- [ ] Add days per week validation (AC: 2)
  - [ ] Create input field with min=1, max=7 validation
  - [ ] Implement real-time validation with error messaging
  - [ ] Add user-friendly input controls (dropdown or number input)
  - [ ] Create validation error display with clear messaging
  - [ ] Test edge cases and boundary conditions

- [ ] Implement justification text area (AC: 3)
  - [ ] Create text area with character counter display
  - [ ] Add minimum 10 character validation
  - [ ] Implement maximum 500 character limit
  - [ ] Create real-time character count with visual feedback
  - [ ] Add helpful placeholder text and guidance

- [ ] Build real-time calculation display (AC: 4)
  - [ ] Create calculation service for immediate feedback
  - [ ] Display distance calculation in real-time
  - [ ] Show daily allowance amount as form is completed
  - [ ] Calculate and display weekly total based on days per week
  - [ ] Add loading states during calculation API calls

- [ ] Implement comprehensive form validation (AC: 5)
  - [ ] Add required field validation for all mandatory inputs
  - [ ] Create client-side validation with immediate feedback
  - [ ] Implement form submission prevention when invalid
  - [ ] Add server-side validation for security
  - [ ] Create validation summary display for user guidance

- [ ] Create submission confirmation flow (AC: 6)
  - [ ] Implement form submission with proper loading states
  - [ ] Create confirmation screen with request ID display
  - [ ] Show calculated allowance summary in confirmation
  - [ ] Add navigation options after successful submission
  - [ ] Implement error handling for submission failures

- [ ] Add auto-save draft functionality (AC: 7)
  - [ ] Implement periodic auto-save of form data
  - [ ] Create draft restoration on form reload
  - [ ] Add user notification of draft save status
  - [ ] Handle multiple browser tabs and session management
  - [ ] Clear drafts after successful submission

## Dev Notes

### Architecture Context
From the architecture document:
- **Frontend:** Angular 17+ with Angular Material form components
- **Real-time Calculation:** API calls to calculation engine for immediate feedback
- **Form Handling:** Angular Reactive Forms with validation
- **State Management:** NgRx for form state and draft management

### UX Requirements
From UX specifications:
- **Forms-first Workflow:** Primary interaction is structured form submission
- **Real-time Validation:** Immediate feedback and calculation preview
- **Mobile Support:** Touch-friendly interfaces for mobile submission (NFR3)
- **Progressive Disclosure:** Complex information revealed appropriately

### Business Requirements
From PRD requirements:
- **Request Workflow:** Employee submits requests with project, manager, justification (FR1)
- **Calculation Preview:** Immediate feedback on calculated allowances (FR3)
- **Data Validation:** Client-side and server-side validation (NFR5)
- **User Experience:** Swiss business professional interface standards

### Form Data Model
Request submission form data:
```typescript
interface TravelRequestFormData {
  projectId: string;
  subProjectId: string;
  managerId: string;
  daysPerWeek: number; // 1-7
  justification: string; // 10-500 chars
}

interface CalculationPreview {
  distance: number; // km, 3 decimal places
  dailyAllowance: number; // CHF, 2 decimal places
  weeklyAllowance: number; // CHF, 2 decimal places
}
```

### Real-time Calculation Flow
- User selects project → Load subprojects
- User selects subproject + has home address → Calculate distance
- Distance + cost rate → Calculate daily allowance
- Daily allowance + days per week → Calculate weekly total

### Testing
- **Test Location:** 
  - Frontend: apps/web/src/app/features/employee/components/__tests__/
  - Integration: apps/web/src/app/__tests__/integration/
- **Test Standards:** 
  - Angular component testing with form interaction
  - Real-time calculation testing with mock services
- **Testing Frameworks:** 
  - Frontend: Angular Testing Utilities with Jest
  - E2E: Playwright for complete form submission flow
- **Specific Requirements:**
  - Test form validation with various input combinations
  - Test real-time calculation updates
  - Test auto-save and draft restoration functionality
  - Test mobile touch interactions and responsive behavior
  - Test error handling and recovery scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 2 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*