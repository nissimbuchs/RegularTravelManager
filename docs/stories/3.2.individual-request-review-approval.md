# Story 3.2: Individual Request Review & Approval

## Status
Approved

## Story
**As a** manager,
**I want** to review individual travel requests with full context and approve or reject them with comments,
**so that** I can make informed decisions and provide clear feedback to employees.

## Acceptance Criteria
1. Request detail view displays all request information including employee details, project context, distance calculation, and allowance breakdown
2. Manager decision interface provides approve/reject buttons with mandatory comment fields for rejection explanations
3. Distance calculation transparency shows exact coordinates, calculation method, and allows manual override with justification
4. Employee context panel displays current workload, recent requests, and historical approval patterns for informed decisions
5. Approval workflow updates request status immediately and triggers email notifications to employee and HR
6. Comment system allows manager to add private notes and employee-visible feedback with timestamp tracking
7. Request modification capability allows manager to adjust days per week or add conditions before approval

## Tasks / Subtasks
- [ ] Create request detail view component (AC: 1)
  - [ ] Design comprehensive request detail layout with Angular Material cards
  - [ ] Display employee information with photo, contact details, and role
  - [ ] Show complete project context including client, budget, and timeline
  - [ ] Present distance calculation with map visualization
  - [ ] Format allowance breakdown with daily, weekly, and monthly totals
  - [ ] Add request timeline showing submission and processing history

- [ ] Build manager decision interface (AC: 2)
  - [ ] Create approve/reject action buttons with confirmation dialogs
  - [ ] Implement mandatory comment field for rejection decisions
  - [ ] Add optional comment field for approval with conditions
  - [ ] Create decision validation to prevent accidental submissions
  - [ ] Add undo functionality for recently made decisions
  - [ ] Implement bulk decision capabilities for similar requests

- [ ] Add distance calculation transparency (AC: 3)
  - [ ] Display exact home and work coordinates with privacy controls
  - [ ] Show calculation method (straight-line distance) with formula
  - [ ] Add map visualization with route overlay
  - [ ] Implement manual distance override with manager justification
  - [ ] Create audit trail for manual overrides
  - [ ] Add recalculation trigger for address updates

- [ ] Build employee context analysis (AC: 4)
  - [ ] Show employee's current approved weekly allowances
  - [ ] Display recent request history with approval patterns
  - [ ] Add workload indicators showing total travel commitments
  - [ ] Create comparison with peer employees in similar roles
  - [ ] Show manager's historical decisions for consistency
  - [ ] Add risk indicators for unusual or high-value requests

- [ ] Implement approval workflow integration (AC: 5)
  - [ ] Update request status in real-time with optimistic updates
  - [ ] Trigger immediate email notifications to relevant parties
  - [ ] Create audit log entries for all status changes
  - [ ] Implement rollback capabilities for system errors
  - [ ] Add integration with HR systems for approved requests
  - [ ] Create dashboard refresh for all connected users

- [ ] Add comprehensive comment system (AC: 6)
  - [ ] Create dual comment types: private notes and employee-visible feedback
  - [ ] Add timestamp tracking and manager identification
  - [ ] Implement comment editing with change history
  - [ ] Add rich text formatting for detailed feedback
  - [ ] Create comment templates for common scenarios
  - [ ] Enable comment attachments for supporting documents

- [ ] Build request modification capabilities (AC: 7)
  - [ ] Allow manager to adjust days per week before approval
  - [ ] Enable date range modifications for seasonal projects
  - [ ] Add conditional approval with specific terms
  - [ ] Create modification history tracking
  - [ ] Implement employee notification for modified approvals
  - [ ] Add recalculation triggers for modified parameters

## Infrastructure Impact Assessment ⚠️ REQUIRED

### Frontend Changes
- [ ] **New Components/Pages** - Request review dialog and approval workflows
- [ ] **State Management** - NgRx actions/effects for approval processing
- [ ] **Routing** - No new routes, enhance existing manager dashboard
- [ ] **API Integration** - HTTP services for approval/rejection operations

### Backend Changes
- [ ] **New API Endpoints** - List all new REST endpoints:
  - [ ] `GET /manager/requests/{id}/details` - Get detailed request information
  - [ ] `PUT /manager/requests/{id}/approve` - Approve request with comments
  - [ ] `PUT /manager/requests/{id}/reject` - Reject request with feedback
  - [ ] `PUT /manager/requests/{id}/modify` - Modify request parameters
- [ ] **Lambda Functions** - New Lambda handlers required:
  - [ ] Handler file: `apps/api/src/handlers/manager/get-request-details.ts`
  - [ ] Handler file: `apps/api/src/handlers/manager/approve-request.ts`
  - [ ] Handler file: `apps/api/src/handlers/manager/reject-request.ts`
  - [ ] Handler file: `apps/api/src/handlers/manager/modify-request.ts`
- [ ] **Database Changes** - Schema modifications needed:
  - [ ] Migration script: `migrations/008-create-approval-comments.sql`
  - [ ] Migration script: `migrations/009-create-request-modifications.sql`
  - [ ] New tables: approval_comments, request_modifications, status_history
- [ ] **Authentication** - Auth/authorization changes:
  - [ ] Manager role verification for approval actions
  - [ ] Enhanced permissions for request modification

### Infrastructure Changes (AWS CDK)
- [ ] **API Gateway** - New routes/methods:
  - File: `infrastructure/src/api-gateway-stack.ts`
  - Routes: /manager/requests/{id}/details, /manager/requests/{id}/approve
- [ ] **Lambda Configuration** - Function definitions:
  - File: `infrastructure/src/lambda-stack.ts`
  - Functions: approveRequestFunction, rejectRequestFunction, modifyRequestFunction
- [ ] **Database** - RDS changes:
  - Tables for approval workflow and audit trail
- [ ] **Environment Variables** - New config needed:
  - Development: `docker-compose.yml` - Approval workflow settings
  - Production: `infrastructure/src/parameter-store.ts` - Notification settings
- [ ] **IAM Permissions** - New service permissions:
  - rds-db:connect for approval operations
  - ses:SendEmail for approval notifications
- [ ] **Other AWS Services**:
  - AWS SES - Email notifications for approvals/rejections
  - CloudWatch - Approval process monitoring

### Development Environment
- [ ] **Docker Services** - No changes required
- [ ] **LocalStack** - SES mocking for approval notifications
- [ ] **Sample Data** - Request approval test scenarios
- [ ] **Environment Setup** - Approval workflow testing ready

## Dev Notes

### Architecture Context
From the architecture document:
- **Frontend:** Angular 17+ with detailed form components and data visualization
- **State Management:** NgRx for complex approval workflow state
- **Real-time Updates:** WebSocket integration for immediate status changes
- **API Integration:** Manager-specific endpoints with comprehensive request data

### Manager Workflow Context
From brainstorming session and PRD:
- **Decision Quality:** Rich context enables informed approval decisions
- **Efficiency:** Streamlined interface supports high-volume processing
- **Transparency:** Complete visibility into calculation and employee context
- **Audit Trail:** Full tracking of decisions and modifications

### Business Requirements
From PRD requirements:
- **Manager Approval:** Review and approve/reject requests with context (FR5)
- **Decision Tracking:** Complete audit trail of manager decisions (FR12)
- **Employee Communication:** Clear feedback and notification system (FR11)
- **Modification Capability:** Manager adjustment of request parameters

### Request Detail Data Model
```typescript
interface RequestDetailView {
  request: TravelRequestDetail;
  employee: EmployeeProfile;
  projectContext: ProjectContext;
  calculationDetail: DistanceCalculationDetail;
  employeeContext: EmployeeWorkloadContext;
  decisionHistory: RequestDecisionHistory[];
}

interface TravelRequestDetail extends TravelRequest {
  submissionContext: {
    ipAddress: string;
    userAgent: string;
    submissionDate: Date;
  };
  attachments: RequestAttachment[];
  modifications: RequestModification[];
}

interface EmployeeWorkloadContext {
  currentWeeklyAllowance: number;
  activeRequestsCount: number;
  approvalRate: number;
  recentRequests: TravelRequestSummary[];
  peerComparison: PeerComparisonData;
}

interface RequestDecision {
  action: 'approve' | 'reject' | 'modify';
  managerComment: string;
  privateNotes?: string;
  modifications?: RequestModification[];
  timestamp: Date;
  managerId: string;
}
```

### Distance Calculation Transparency
- **Coordinate Display:** Home and work addresses with privacy controls
- **Calculation Method:** Straight-line distance using PostGIS ST_Distance
- **Manual Override:** Manager can adjust with required justification
- **Audit Trail:** All overrides tracked with timestamps and reasons

### Performance Requirements
- **Response Time:** Request detail load under 300ms (NFR1)
- **Real-time Updates:** Status changes reflected within 1 second
- **Concurrent Decisions:** Support multiple managers reviewing simultaneously
- **Data Loading:** Lazy loading for employee context and history

### Testing
- **Test Location:** 
  - Frontend: apps/web/src/app/features/manager/components/__tests__/
  - Integration: apps/web/src/app/__tests__/manager-approval/
- **Test Standards:** 
  - Angular component testing with approval workflow simulation
  - Decision process testing with mock data and real-time updates
- **Testing Frameworks:** 
  - Frontend: Angular Testing Utilities with Jest
  - E2E: Playwright for complete approval workflow testing
- **Specific Requirements:**
  - Test approval/rejection workflow with various scenarios
  - Test distance calculation display and manual override
  - Test employee context loading and analysis
  - Test comment system and notification triggers
  - Test request modification capabilities
  - Test real-time updates and concurrent access scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation from PRD Epic 3 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*